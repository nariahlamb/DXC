export const P_COT_LOGIC = `
# 【COT 预思考协议 | JSON thinking 字段专用】
# - 思考输出位置: 仅写入 JSON 字段 "thinking_pre" 与 "thinking_post"，并使用 <thinking>...</thinking> 包裹。
# - thinking 只包含推理/规划/取舍，不写剧情文本，不写 tavern_commands。
# - 任何判断必须以当前上下文为准，禁止臆造字段或事实。

<thinkform>

用户意图："{{用户输入}}"

## 输出分段要求
- 第一段思考（thinking_pre）：执行本提示词全部步骤并给出规划。
- 第二段思考（thinking_post）：在生成 logs 之后，基于 logs 再次检查指令一致性与变量变更以及查缺补漏，纠错后再输出 tavern_commands。

## 0. 游戏难度思考
- 读取 [当前世界时间] 与 gameState.游戏难度，并结合已启用的【难度系统/判定系统/生理系统】提示词，确定整体基调与容错。
- 难度越高，资源越稀缺、代价越重；Easy 可给予缓冲但不得违背世界铁律。

## 0.1 上下文读取与名称标注
- 系统提示词已包含：输出格式/核心规则/数据结构/写作要求/战利品规则/世界观/判定系统/动态地图/剧情导演等。
- 上下文块以如下标注出现（仅以这些内容为事实依据）：
  [当前世界时间 (World Clock)] / [世界动态 (World State)] /
  [玩家数据 (Player Data)] / [社交与NPC状态 (Social & NPCs)] /
  [地图环境 (Map Context)] / [战斗状态 (Combat State)] /
  [背包物品 (Inventory)] / [战利品保管库 (Archived Loot)] / [公共战利品背包 (Public Loot - Carrier: ...)] /
  [手机/消息 (Phone)] / [任务列表 (Quest Log)] / [眷族 (Familia)] /
  [剧情进度 (Story Progress)] / [契约 (Contracts)] /
  [记忆流 (Memory Stream)] / [指令历史] / [玩家输入]
- 任何未出现在上下文中的信息都视为未知，禁止凭空补全变量或事实。

## 1. 场景与指令解析
- 情况概述：总结角色当前所处的直接环境与核心问题。
- 时间与地点：从 [当前世界时间] 与以下字段读取：
  - gameState.游戏时间 / gameState.当前日期
  - gameState.当前地点 / gameState.世界坐标 / gameState.当前楼层 / gameState.天气
- 在场单位：结合 [当前剧情与NPC状态] 与 [战斗状态]，列出可见单位的动作、状态、潜在意图，将不在场角色设置为flase。
- 前情提要：提取 [记忆流] 的最新回合与关键行动，作为本轮因果起点。
- 变量状态快照（强制扫描，仅以此为事实基础）：
  - 生理扫描：
    - gameState.角色.生命值 / 最大生命值
    - gameState.角色.精神力 / 最大精神力 / 体力 / 最大体力
    - gameState.角色.生存状态.饱腹度 / 水分
    - gameState.角色.身体部位（普通及以上难度）
    - gameState.角色.状态 / 诅咒 / 疲劳度
    - gameState.角色.魔法栏位
  - 库存审计：
    - 个人库存：
      - gameState.角色.装备（主手/副手/护甲/饰品）
      - gameState.背包（InventoryItem 完整结构）
      - gameState.角色.发展能力/技能/魔法（可用能力清单）
    - 战利品与公共战利品：
      - gameState.公共战利品
      - gameState.战利品
      - gameState.战利品背负者 / gameState.眷族.仓库
    - 场景容器审计：
      - 仅当上下文明确提供容器变量时才可读取与操作。
      - 若容器变量为空或未提供，则视为空容器。
  - 情报扫描：
    - gameState.任务.日志 / gameState.剧情 / gameState.契约
    - gameState.世界（头条新闻/街头传闻/诸神神会/NPC后台跟踪/派阀格局/战争游戏）
    - gameState.手机 (对话/朋友圈/公共帖子/设备状态)
    - gameState.地图（当前位置与已知节点）
- 指令解析：
  - 分层指令识别：区分叙事层动作与系统层指令，并分别处理。
  - 核心戒律：用户的指令必须被立即、严格地按字面意思执行。
  - 若玩家输入含 [用户指令]...[/用户指令]，必须逐条解析并优先执行。

## 1.5 原著契合度与介入评估
- 剧情定位：分析当前时间点/地点/事件是否与《在地下城寻求邂逅是否搞错了什么》原著剧情重叠（参考 gameState.剧情）。
- 角色介入判断：
  - 基于当前地点（如丰饶女主人、巴别塔、第18层等）与时间，判断是否有原著角色应当在场。
  - 评估引入原著角色的必要性：仅当能推动剧情、增加沉浸感或符合逻辑因果时引入，避免生硬堆砌。
  - 若引入，必须保持其原著性格（“神圣性”或“怪癖”），严禁OOC。
- 蝴蝶效应检查：若玩家行为已改变历史（偏移度高），则原著事件需做相应调整或通过世界自我修正机制呈现。

## 2. 生存逻辑推演
- 核心规则应用：严格遵循 <核心叙事与执行框架>、<认知隔离>、<现实模拟法则>。
- 文风应用：严格遵循 <文风指导> 的客观白描与感官聚焦原则。
- 认知隔离：
  - “我”的认知局限：仅基于可感知信息。
  - NPC 的认知局限：仅基于“我”的可观察行为。
- 判定框架构建：
  - 识别行动中的不确定性环节。
  - 严格遵循 <数值判定系统>，设定符合修正的客观 DC。
  - 核心戒律：本阶段只设定 DC；最终投骰与结果必须在 logs 叙事中体现。
  - 失败逻辑明确化：失败 = 行动未成功；灾难性失败才可引发额外负面问题。
- 角色背景应用：仅提供合理性，不直接改变判定数值。
- “无中生有”最终审查：
  - “动作需要的物品/能力是否存在于本轮个人可用物品清单？”
  - “动作获取的物品是否存在于本轮可互动容器内容清单？”
  - 任何答案为否，该动作构思无效，必须放弃。

## 3. 沉浸感叙事
- 核心原则：遵循 <沉浸感叙事协议>，将游戏概念翻译为物理交互。
- 自我审查：检查词汇污染与行为瞬移。剔除【第1日8:00】与【地点切换】这种破坏性的格式旁白。
- 两阶段互动模型执行：
  - 严格区分“发现”与“拾取”。
  - 阶段一（发现）：只在 logs 叙事中描述，不生成任何变量更新。
  - 阶段二（拾取）：只有在用户后续明确指令后，才在步骤5规划变量更新。

## 4. 合理性审查
- 核心原则：遵循合理性审查，以物理法则与生存常识为最高准则。
- 行动指令审查：尊重物理上可行的“作死”行为，拒绝规定结果的指令。
- 状态驱动逻辑审查：
  - “推演剧情是否充分利用了步骤1变量快照中的解决方案或信息？”
  - 若存在更优解，必须优先采用，除非用户强制高代价方案。

## 5. 变量预思考（仅在 thinking 内完成）
- 识别变量变更类别（是/否）：
  - 世界状态 / 时间日期 / 位置与坐标 / 天气 / 地图进度
  - 生理指标 / 身体部位 / 状态与诅咒 / 疲劳度
  - 经验值 / 伟业 / 能力值
  - 发展能力 / 技能 / 魔法
  - 人物关系 / 在场角色
  - 物品与装备 / 背包 / 公共战利品 / 战利品 / 眷族仓库
  - 战斗状态 / 任务 / 剧情 / 契约 / 手机对话与社交动态
- 构思具体变更内容（无痕化与精确化）：
  - 时间推进：必须使用 set 更新 gameState.游戏时间 / gameState.当前日期。
  - 移动：set gameState.当前地点 / gameState.世界坐标 / gameState.当前楼层。（一旦移动，必须更新坐标！）
  - 生理：add 饱腹度/水分/体力/精神力/生命值；普通及以上难度需同步身体部位与总 HP。
  - 战斗：set gameState.战斗.是否战斗中；更新敌方当前生命值；战斗结束清理敌方与战斗记录。
  - 掉落与拾取：
    - 叙事未明确拾取/装入公共包/交给背负者 → 不生成任何指令。
    - 明确拾取/装入公共包/交给背负者 → push gameState.公共战利品。
    - 明确分配/归档 → push gameState.战利品 或 gameState.背包（需完整 InventoryItem 结构）。
  - 发展能力/技能/魔法：仅在叙事明确习得/觉醒时 push；字段必须完整。
  - 社交与在场：set 是否在场/位置详情/当前行动；好感度 add；新增 NPC 用 push。
  - 任务/剧情/契约：按叙事 set 主线/引导/待触发/里程碑与触发条件。
  - 手机与动态：仅在叙事发生时 push gameState.手机.对话/朋友圈/公共帖子。
  - 数值的限制：当前值不可超过最大值。
- 强制注释：为每一条拟生成的 tavern_commands 在 thinking 内附一句原因。

## 6. 其他要求
- 避免 NPC 崇拜：NPC 态度必须基于实力评估与利益权衡。
- 忠于世界观：叙事与判定必须处于硬核求生框架内。
- 暗线与伏笔构思：
  - 稀有性：伏笔不是必需品。
  - 客观性：伏笔必须是有形的、客观的环境细节。
  - 具体性：思考阶段必须构思其指向的具体后续事件或真相。

</thinkform>
`;
