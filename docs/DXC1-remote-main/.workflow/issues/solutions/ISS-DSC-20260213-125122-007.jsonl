{"id":"SOL-ISS-DSC-20260213-125122-007-c5m6","description":"为性能模式检测增加非浏览器上下文保护，避免 SSR/受限环境运行时报错。","approach":"对 navigator/window/localStorage 访问统一包裹运行时守卫与异常兜底，保证 hook 在无 DOM 环境也能稳定返回默认模式。","tasks":[{"id":"T1","title":"Fix runtime guards in detectPerformanceMode","scope":"hooks/usePerformanceMode.ts","action":"Fix","description":"在检测函数中加入 window/navigator 可用性判断与默认值兜底。","modification_points":[{"file":"hooks/usePerformanceMode.ts","target":"detectPerformanceMode","change":"访问 navigator 前增加 typeof window / typeof navigator 守卫，失败时返回默认模式"}],"implementation":["新增安全读取环境信息的辅助函数","当运行环境无 navigator 时直接使用保守默认评分","保证 detectPerformanceMode 在任何上下文都不抛异常"],"test":{"unit":["无 window 环境下 detectPerformanceMode 返回合法模式"],"integration":["hook 在 jsdom 以外环境可初始化"],"commands":["npx tsc --noEmit"],"coverage_target":0.7},"acceptance":{"criteria":["在 3 种上下文（browser/jsdom/no-window）初始化 hook 均不抛错","detectPerformanceMode 返回值始终属于 full|medium|minimal"],"verification":["执行命令: npx vitest run tests/hooks/usePerformanceMode.test.ts","执行命令: npx tsc --noEmit"],"manual_checks":["在浏览器中切换窗口大小后性能模式仍可更新"]},"commit":{"type":"fix","scope":"performance-mode","message_template":"fix(perf): guard performance detection in non-browser runtime","breaking":false},"depends_on":[],"estimated_minutes":25,"priority":1},{"id":"T2","title":"Update localStorage access safety","scope":"hooks/usePerformanceMode.ts","action":"Update","description":"为 getStoredMode / updatePerformanceMode / resetToAutoDetect 增加 localStorage 异常兜底。","modification_points":[{"file":"hooks/usePerformanceMode.ts","target":"getStoredMode and localStorage writes","change":"增加 try/catch 与 typeof window 判定，失败时降级为内存态"}],"implementation":["抽取 safeGetItem/safeSetItem/safeRemoveItem 辅助函数","在 localStorage 读写异常时记录 warn 并继续运行","确保 isAutoDetected 状态在降级路径下逻辑正确"],"test":{"unit":["localStorage 抛异常时 hook 不崩溃"],"integration":["persist=false/true 两种路径状态正确"],"commands":["npx vitest run tests/hooks/usePerformanceMode.test.ts"],"coverage_target":0.78},"acceptance":{"criteria":["模拟 localStorage get/set/remove 抛错时，hook 渲染成功率=100%","降级路径下 performanceMode 仍为合法枚举值"],"verification":["执行命令: npx vitest run tests/hooks/usePerformanceMode.test.ts --reporter=basic","执行命令: rg -n \"navigator as any\" hooks/usePerformanceMode.ts，结果为 0 行"],"manual_checks":["浏览器隐私模式下手动切换性能档位"]},"commit":{"type":"fix","scope":"performance-mode","message_template":"fix(perf): harden localStorage access for restricted environments","breaking":false},"depends_on":["T1"],"estimated_minutes":20,"priority":1},{"id":"T3","title":"Add non-browser regression tests for performance mode","scope":"tests/hooks","action":"Add","description":"新增 usePerformanceMode 的非浏览器上下文与异常路径测试。","modification_points":[{"file":"tests/hooks/usePerformanceMode.test.ts","target":"new test suite","change":"新增无 window、无 navigator、localStorage 异常场景用例"}],"implementation":["通过 mock globalThis.window/navigator 构造受限环境","断言 hook 初始化与 update/reset 方法均不抛错","覆盖 resize listener 的注册与清理路径"],"test":{"unit":["环境守卫回归测试"],"integration":["hook 生命周期回归"],"commands":["npx vitest run tests/hooks/usePerformanceMode.test.ts","npx tsc --noEmit"],"coverage_target":0.82},"acceptance":{"criteria":["新增用例至少 3 条（no-window/no-navigator/storage-throw）","测试命令连续执行 2 次通过率=100%"],"verification":["执行命令: npx vitest run tests/hooks/usePerformanceMode.test.ts","执行命令: npx vitest run tests/hooks/usePerformanceMode.test.ts"],"manual_checks":["Smoke 验证主界面渲染不受影响"]},"commit":{"type":"test","scope":"performance-mode","message_template":"test(perf): add non-browser guard regression tests","breaking":false},"depends_on":["T2"],"estimated_minutes":30,"priority":2}],"analysis":{"risk":"low","impact":"high","complexity":"low"},"score":0.94,"is_bound":true,"created_at":"2026-02-13T13:18:11.617Z","bound_at":"2026-02-13T13:23:17.123Z"}
