{"id":"SOL-ISS-DSC-20260213-125122-008-1","description":"抽取联系人在场判定为共享工具，统一 SocialPhoneModal/ContactsView/usePhoneData 逻辑。","approach":"新增单一真值来源工具函数并替换 3 处内联实现，最后通过单测和静态搜索保证重复逻辑归零。","tasks":[{"id":"T1","title":"提取联系人在场判定工具函数","scope":"utils/social","action":"Add","description":"新增 contact presence 工具，统一是否在场与状态字段的兼容判定。","modification_points":[{"file":"utils/social/contactPresence.ts","target":"新建工具","change":"导出 isContactNearby/isContactPresent 状态判断函数"},{"file":"types","target":"Confidant 类型引用","change":"补充工具函数入参类型约束"}],"implementation":["定义布尔字段优先、状态字段兜底的判定顺序。","覆盖 在场/离场/死亡/失踪 与空状态输入。","输出纯函数，禁止依赖组件上下文。"],"test":{"unit":["presence by boolean","presence by status","fallback behavior"],"commands":["npx vitest run tests/utils/contactPresence.test.ts --testTimeout=60000","npx tsc --noEmit"]},"acceptance":{"criteria":["contactPresence 工具单测不少于 6 条且全部通过。","工具函数对 4 种状态值（在场/离场/死亡/失踪）输出符合预期。"],"verification":["执行 npx vitest run tests/utils/contactPresence.test.ts --testTimeout=60000 并通过。","执行 npx tsc --noEmit 返回 0。"]},"priority":1},{"id":"T2","title":"替换三处重复在场判定实现","scope":"components/hooks","action":"Update","description":"将 SocialPhoneModal、ContactsView、usePhoneData 的内联 isContactNearby 替换为共享工具调用。","modification_points":[{"file":"components/game/modals/SocialPhoneModal.tsx","target":"isContactNearby 定义","change":"改为导入共享工具"},{"file":"components/game/modals/social/ContactsView.tsx","target":"isContactNearby 定义与统计","change":"改为导入共享工具"},{"file":"hooks/game/usePhoneData.ts","target":"isContactNearby 定义","change":"改为导入共享工具"}],"implementation":["移除本地重复函数并统一 import 路径。","保持原过滤表达式结构，仅替换判定实现。","修复类型断言 (c as any) 依赖，使用工具内部兼容。"],"test":{"unit":["consumer calls shared presence utility"],"commands":["powershell -Command \"(rg --line-number 'const isContactNearby' components/game/modals/SocialPhoneModal.tsx components/game/modals/social/ContactsView.tsx hooks/game/usePhoneData.ts | Measure-Object).Count\"","npx vitest run tests/utils/contactPresence.test.ts --testTimeout=60000"]},"acceptance":{"criteria":["上述 3 个文件中的本地 isContactNearby 定义数量从 3 降至 0。","三个调用点均通过共享工具完成在场判定。"],"verification":["执行 rg 计数命令返回 0。","执行 npx vitest run tests/utils/contactPresence.test.ts --testTimeout=60000 并通过。"]},"depends_on":["T1"],"priority":1},{"id":"T3","title":"补充联系人视图回归验证","scope":"tests/components","action":"Add","description":"新增联系人相关视图回归用例，确认替换后筛选结果不变。","modification_points":[{"file":"tests/components/contactsPresence.integration.test.tsx","target":"新建测试","change":"覆盖 special/nearby/valid 三类联系人分组"},{"file":"components/game/modals/social/ContactsView.tsx","target":"分组展示","change":"必要时导出可测试辅助函数"}],"implementation":["构造混合状态联系人数据集（布尔+状态字符串）。","断言关注/周围/有效联系人分组数量一致。","验证 UI 过滤结果与工具函数预期一致。"],"test":{"unit":["contacts grouping regression"],"commands":["npx vitest run tests/components/contactsPresence.integration.test.tsx --testTimeout=60000","npm test"]},"acceptance":{"criteria":["新增联系人回归测试不少于 4 条断言。","npm test 全量通过且无新增失败。"],"verification":["执行 npx vitest run tests/components/contactsPresence.integration.test.tsx --testTimeout=60000 并通过。","执行 npm test 并通过。"]},"depends_on":["T2"],"priority":2}],"analysis":{"risk":"low","impact":"medium","complexity":"medium"},"score":0.93,"is_bound":true,"created_at":"2026-02-13T13:24:36.623Z","bound_at":"2026-02-13T13:25:32.238Z"}
