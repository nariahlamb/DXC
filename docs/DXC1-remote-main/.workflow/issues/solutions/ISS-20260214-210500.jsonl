{"id":"SOL-ISS-20260214-210500-r7k2","description":"梳理并优化 issue 填表中的 state/status 约束，统一前后端校验与提示，补足可扩展配置。","approach":"先补齐项目级 state 约束配置（当前 .workflow/project-tech.json 与 .workflow/project-guidelines.json 缺失），再在 API、CLI、Dashboard 三层统一使用同一套 state/status 枚举、别名与错误提示；最后用回归脚本验证现有 .workflow/issues 数据不被破坏。重点解决当前问题：1）state 选项硬编码且提示弱；2）服务端与 CLI 缺少一致性校验；3）拉取参数存在约束表达与注入风险；4）扩展新状态缺少单一入口。","tasks":[{"id":"T1","title":"Create 项目级 state 约束配置基线","scope":".workflow 配置","action":"Create","description":"新增 project-tech 与 project-guidelines 中的 issue state policy，明确可填值、别名、限制项与扩展入口。","modification_points":[{"file":".workflow/project-guidelines.json","target":"issue_state_policy","change":"新增 github_pull_state、issue_status、alias_map、transition_rules、error_templates"},{"file":".workflow/project-tech.json","target":"issue_workflow","change":"声明 state 字段来源、默认值、扩展策略与兼容版本"}],"implementation":["定义 github_pull_state 枚举（open/closed/all）与 issue_status 枚举（8 个生命周期状态），并给出中文说明。","定义 alias_map（不少于 4 个别名）与 transition_rules（覆盖全部 8 个 status 的合法流转）。","补充错误提示模板（非法值、非法流转、扩展冲突）与扩展规范（新增 state 的最小字段集）。"],"test":{"unit":["配置结构校验：issue_state_policy 必填键存在","枚举完整性校验：github_pull_state=3 项、issue_status=8 项"],"commands":["node -e \"const fs=require('fs');const g=JSON.parse(fs.readFileSync('.workflow/project-guidelines.json','utf8'));if(!g.issue_state_policy) throw new Error('missing issue_state_policy');if((g.issue_state_policy.github_pull_state||[]).length!==3) throw new Error('invalid github_pull_state count');if((g.issue_state_policy.issue_status||[]).length!==8) throw new Error('invalid issue_status count');\"","node -e \"const fs=require('fs');const t=JSON.parse(fs.readFileSync('.workflow/project-tech.json','utf8'));if(!t.issue_workflow) throw new Error('missing issue_workflow');\""],"coverage_target":0.8},"regression":["不修改现有 .workflow/issues/*.jsonl 业务数据","不改变现有 issue_id 与 bound_solution_id"],"acceptance":{"criteria":["project-guidelines 中包含 1 个完整 issue_state_policy 节点，含 5 类子配置（枚举/别名/流转/错误模板/扩展规范）","github_pull_state 精确为 3 个可选值，issue_status 精确为 8 个可选值","transition_rules 覆盖 8 个 status，且每个 status 至少定义 1 条合法后继"],"verification":["执行 node 校验命令并确认 exit code=0","人工检查枚举项、别名字典与流转矩阵是否齐全","对比 git diff，确认仅新增/更新 2 个 .workflow 配置文件"]},"commit":{"type":"docs","scope":"issue-state-policy","message_template":"docs: 新增 issue state 约束与扩展策略配置","breaking":false},"depends_on":[],"estimated_minutes":35,"priority":1},{"id":"T2","title":"Fix API 层 state/status 输入校验与安全约束","scope":"issue routes","action":"Fix","description":"在 issue-routes 中统一校验 state/status，拦截非法值与注入式输入，输出可读错误与 allowed_values。","modification_points":[{"file":"C:/Users/mariah'lamb/AppData/Roaming/npm/node_modules/claude-code-workflow/ccw/src/core/routes/issue-routes.ts","target":"POST /api/issues/pull 参数解析","change":"state 改为枚举校验 + 白名单执行参数，不允许任意拼接"},{"file":"C:/Users/mariah'lamb/AppData/Roaming/npm/node_modules/claude-code-workflow/ccw/src/core/routes/issue-routes.ts","target":"POST/PATCH /api/issues status 写入","change":"新增 status 校验、别名归一、非法流转拦截"}],"implementation":["实现统一 normalizeState/normalizeStatus 方法，读取 T1 配置并提供默认回退。","把 gh 调用改为参数数组执行（避免字符串拼接命令注入），并对 labels 做格式白名单校验。","统一错误响应格式：error_code、message、allowed_values、received_value。"],"test":{"unit":["非法 state 返回 400 且带 allowed_values","非法 status/非法流转返回 400 并给出原因","注入 payload（如 open;echo pwned）被拒绝"],"commands":["npm test -- issue-routes.state-validation.test.ts","node scripts/issue-state-api-smoke.mjs"],"coverage_target":0.85},"regression":["open/closed/all 三种合法 state 维持可用","现有 POST /api/issues 创建 registered 默认行为不变"],"acceptance":{"criteria":["3 类非法输入（非法 state、非法 status、非法流转）均返回 HTTP 400 且错误体包含 allowed_values","注入样例至少 5 条全部被拒绝，且执行日志中不出现拼接命令","合法 state=open|closed|all 请求成功率 100%"],"verification":["运行 API 单测并确认相关用例全绿","执行 smoke 脚本检查返回码与错误体字段","代码审查确认 gh 调用不再使用拼接字符串命令"]},"commit":{"type":"fix","scope":"issue-api-state","message_template":"fix: 统一 issue API 的 state/status 校验并加固输入安全","breaking":false},"depends_on":["T1"],"estimated_minutes":70,"priority":1},{"id":"T3","title":"Update Dashboard state 填表体验与限制提示","scope":"issue manager UI","action":"Update","description":"优化 Pull Issues 弹窗的 state 项展示、限制说明与交互校验，提升可填体验与错误可理解性。","modification_points":[{"file":"C:/Users/mariah'lamb/AppData/Roaming/npm/node_modules/claude-code-workflow/ccw/src/templates/dashboard-js/views/issue-manager.js","target":"pullIssueState 下拉与 pullGitHubIssues 提交逻辑","change":"由固定选项改为配置驱动渲染，提交前做前端校验与提示"},{"file":"C:/Users/mariah'lamb/AppData/Roaming/npm/node_modules/claude-code-workflow/ccw/src/templates/dashboard-css/32-issue-manager.css","target":"form-hint / validation state 样式","change":"补充 state 约束提示与错误态样式"}],"implementation":["从 API 元数据读取可用 state 列表（含 label/description/限制项），动态渲染下拉选项。","为 state 字段增加 help 文案：用途、限制、默认值、可扩展说明。","提交前校验值是否在 allowed_values 内；非法时阻止请求并显示明确错误。"],"test":{"unit":["state 下拉选项数量与 API 返回值一致","非法 state 输入时前端阻止提交且出现错误提示","合法 state 触发请求参数正确"],"commands":["npm test -- issue-manager.state-form.test.ts","npm run build"],"coverage_target":0.8},"regression":["Pull Issues 其他字段（limit、labels、downloadImages）行为不变","默认 state 仍为 open"],"acceptance":{"criteria":["UI 显示的 state 选项数量与后端 allowed_values 完全一致（差异=0）","非法值提交被阻断且 100% 显示错误提示（至少覆盖 3 种错误输入）","state 提示区至少展示 3 类信息：用途、限制、扩展说明"],"verification":["运行前端测试并检查断言通过","手工验证 pull modal 中 state 字段提示内容与默认值","检查 network 请求参数仅在合法 state 时发送"]},"commit":{"type":"feat","scope":"issue-dashboard-state","message_template":"feat: 优化 issue state 填表体验与限制提示","breaking":false},"depends_on":["T2"],"estimated_minutes":55,"priority":2},{"id":"T4","title":"Refactor CLI 的 state/status 约束与错误反馈","scope":"ccw issue CLI","action":"Refactor","description":"在 issue CLI 中统一 state/status 校验、别名归一和错误信息，保证与 API 口径一致。","modification_points":[{"file":"C:/Users/mariah'lamb/AppData/Roaming/npm/node_modules/claude-code-workflow/ccw/src/commands/issue.ts","target":"pullAction/updateAction/createIssue","change":"增加 state/status 校验与别名归一；非法输入提前失败"},{"file":"C:/Users/mariah'lamb/AppData/Roaming/npm/node_modules/claude-code-workflow/ccw/src/commands/issue.ts","target":"错误输出文案","change":"输出 allowed_values、推荐值与示例命令"}],"implementation":["抽取共享校验逻辑（复用 T1 配置），避免 CLI/API 各自维护枚举导致漂移。","对 --state 与 --status 做统一 parse+validate，支持别名归一但不接受未知值。","补充失败提示：显示收到值、可选值、快速修复示例命令。"],"test":{"unit":["invalid --state 在执行 gh 命令前即失败","invalid --status 返回标准错误格式","别名输入可被正确归一"],"commands":["npm test -- issue-cli-state-validation.test.ts","npm run build"],"coverage_target":0.85},"regression":["ccw issue status/list/solution/bind 原有行为不受影响","合法 --state/--status 参数兼容旧脚本调用"],"acceptance":{"criteria":["CLI 对非法 --state/--status 均返回非 0 退出码并打印 allowed_values","别名归一覆盖不少于 4 个映射场景，全部测试通过","CLI 与 API 的 allowed_values 集合一致率 100%"],"verification":["运行 CLI 单测并确认失败分支/归一分支均覆盖","对比 CLI 与 API 输出的 allowed_values 快照","手工执行 3 条非法参数命令并核对错误文本"]},"commit":{"type":"refactor","scope":"issue-cli-state","message_template":"refactor: 统一 issue CLI 的 state/status 约束与提示","breaking":false},"depends_on":["T1"],"estimated_minutes":60,"priority":2},{"id":"T5","title":"Test 现有 issue 数据兼容与迁移校验","scope":".workflow/issues 数据","action":"Test","description":"新增校验脚本扫描 issues/history/queues 的状态值合法性，确保新约束上线后历史数据可兼容。","modification_points":[{"file":".workflow/scripts/validate-issue-state.mjs","target":"JSONL/JSON 扫描器","change":"校验 issue.status、queue.status、item.status，输出 invalid 清单与统计"},{"file":".workflow/issues/issues.jsonl","target":"兼容性检查","change":"仅验证不改写；必要时输出建议迁移报告"},{"file":".workflow/issues/issue-history.jsonl","target":"兼容性检查","change":"仅验证不改写；必要时输出建议迁移报告"},{"file":".workflow/issues/queues/index.json","target":"兼容性检查","change":"校验 active queue 状态与统计字段一致性"}],"implementation":["实现严格校验脚本，支持 --strict 模式与 JSON 报告输出。","对当前仓库 .workflow/issues 数据执行一次全量扫描并产出 invalid 统计。","若发现异常，仅输出迁移建议，不直接覆盖历史数据。"],"test":{"unit":["脚本对合法样本返回 invalid_count=0","脚本对非法样本返回精确行号与字段路径"],"commands":["node .workflow/scripts/validate-issue-state.mjs --path .workflow/issues --strict","ccw issue status ISS-20260214-210500 --json"],"coverage_target":0.8},"regression":["历史 issue 数据不被自动重写","队列 active_queue_id 与 queues 列表关系保持一致"],"acceptance":{"criteria":["扫描覆盖 3 类文件（issues/history/queues）且报告包含总条数、非法条数、字段分布","当前仓库扫描结果 invalid_count=0（若 >0 必须输出完整迁移建议）","脚本在当前数据规模下执行时长 < 5 秒"],"verification":["执行校验脚本并保存输出报告","复核报告中的 file/path/line 定位信息","再次执行 ccw issue status 命令确认 issue 读取不受影响"]},"commit":{"type":"test","scope":"issue-state-migration","message_template":"test: 增加 issue state 数据兼容与迁移校验脚本","breaking":false},"depends_on":["T2","T3","T4"],"estimated_minutes":45,"priority":3}],"exploration_context":{"project_structure":"DXC 项目内维护 .workflow/issues 数据；issue 交互由 ccw 包中的 CLI、API routes 与 dashboard 模板共同驱动。","relevant_files":[".workflow/issues/issues.jsonl",".workflow/issues/issue-history.jsonl",".workflow/issues/queues/index.json","C:/Users/mariah'lamb/AppData/Roaming/npm/node_modules/claude-code-workflow/ccw/src/commands/issue.ts","C:/Users/mariah'lamb/AppData/Roaming/npm/node_modules/claude-code-workflow/ccw/src/core/routes/issue-routes.ts","C:/Users/mariah'lamb/AppData/Roaming/npm/node_modules/claude-code-workflow/ccw/src/templates/dashboard-js/views/issue-manager.js"],"patterns":"Issue 状态在不同层存在重复定义与硬编码；Dashboard pull modal 的 state 为静态下拉，API/CLI 对输入缺少统一强校验。","integration_points":"POST /api/issues/pull 的 state 参数、POST/PATCH /api/issues 的 status 字段、ccw issue pull/update 的 state/status 参数。"},"analysis":{"risk":"medium","impact":"high","complexity":"medium"},"score":0.93,"is_bound":true,"created_at":"2026-02-14T13:15:27.974Z","bound_at":"2026-02-14T13:15:36.897Z"}
