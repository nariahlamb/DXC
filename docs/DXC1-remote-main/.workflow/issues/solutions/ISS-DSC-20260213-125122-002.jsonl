{"id":"SOL-ISS-DSC-20260213-125122-002-a1h2","description":"修复 Home 场景空头像导致的无效图片请求，避免 SettingsModal 渲染空 src。","approach":"在 Home 侧不再传递空字符串头像，并在 SettingsModal 头像区域增加 src 非空守卫与占位渲染；补充 UI 回归测试确保空头像不触发请求。","tasks":[{"id":"T1","title":"Update Home avatar input normalization","scope":"components/Home.tsx","action":"Update","description":"梳理 Home 预览状态来源，确保传递给 SettingsModal 的 avatarUrl 不是空字符串。","modification_points":[{"file":"components/Home.tsx","target":"SettingsModal avatarUrl prop","change":"将 \"\" 替换为非空校验后的值，空值时传 undefined 或默认占位值"}],"implementation":["在 Home 初始化预览 gameState 时提取 avatar 字段并做 trim 归一化","调整 SettingsModal 调用参数，禁止向 avatarUrl 传入空字符串","保留 Home 现有开局/读档流程，不引入行为变更"],"test":{"unit":["Home 传入空头像时，avatarUrl 不等于空字符串"],"integration":["打开 Home 设置面板时头像区域可正常渲染占位"],"commands":["npx tsc --noEmit"],"coverage_target":0.7},"acceptance":{"criteria":["Home 中 SettingsModal 的 avatarUrl 传参空字符串出现次数为 0","Home 打开设置时不会因 avatarUrl=\"\" 触发无效图片请求"],"verification":["执行命令: rg -n \"avatarUrl=\\\"\\\"\" components/Home.tsx，结果为 0 行","执行命令: npx vitest run tests/ui/homeSettingsAvatarGuard.test.tsx，全部用例通过"],"manual_checks":["在浏览器 Network 面板确认无 src 为空的图片请求"]},"commit":{"type":"fix","scope":"home-settings","message_template":"fix(home): avoid empty avatar src in settings modal","breaking":false},"depends_on":[],"estimated_minutes":20,"priority":1},{"id":"T2","title":"Fix SettingsModal avatar rendering guard","scope":"components/game/modals/SettingsModal.tsx","action":"Fix","description":"在头像渲染处添加 src 非空保护，空值时显示占位 UI。","modification_points":[{"file":"components/game/modals/SettingsModal.tsx","target":"renderVisualsView avatar block around img src={avatarPreview}","change":"增加 avatarPreview 非空判断，空值分支渲染占位"}],"implementation":["新增安全 src 变量（trim 后判空）","仅在 src 有效时渲染 <img>，否则渲染占位 icon/文本","保持上传头像后预览更新逻辑不变"],"test":{"unit":["avatarPreview 为空时不渲染 img 节点"],"integration":["上传头像后恢复 img 渲染"],"commands":["npx vitest run tests/ui/settingsModalAvatarPreview.test.tsx"],"coverage_target":0.75},"acceptance":{"criteria":["当 avatarPreview 为空时，头像区域 img 元素数量=0","当 avatarPreview 为有效 data/url 时，头像区域 img 元素数量=1"],"verification":["执行命令: npx vitest run tests/ui/settingsModalAvatarPreview.test.tsx，断言通过","执行命令: npm test -- tests/ui/settingsModalAvatarPreview.test.tsx，退出码为 0"],"manual_checks":["在 Home 打开设置并上传头像，确认 UI 正常切换"]},"commit":{"type":"fix","scope":"settings-modal","message_template":"fix(settings): guard avatar image render for empty src","breaking":false},"depends_on":["T1"],"estimated_minutes":25,"priority":1},{"id":"T3","title":"Add regression tests for empty avatar request","scope":"tests/ui","action":"Add","description":"补充 Home+SettingsModal 联动回归测试，验证空头像不触发无效请求。","modification_points":[{"file":"tests/ui/homeSettingsAvatarGuard.test.tsx","target":"new test suite","change":"新增空头像场景、上传头像场景断言"}],"implementation":["mock Home 打开 settings 场景并注入空头像","断言渲染结果无空 src 图片","增加上传后渲染有效图片的正向断言"],"test":{"unit":["空头像守卫回归测试"],"integration":["Home 与 SettingsModal 交互回归"],"commands":["npx vitest run tests/ui/homeSettingsAvatarGuard.test.tsx","npx tsc --noEmit"],"coverage_target":0.8},"acceptance":{"criteria":["新增测试文件至少包含 2 个用例（空头像/有效头像）","相关测试命令一次执行通过率=100%"],"verification":["执行命令: npx vitest run tests/ui/homeSettingsAvatarGuard.test.tsx","执行命令: npx tsc --noEmit"],"manual_checks":["回归检查 Home 主菜单设置入口"]},"commit":{"type":"test","scope":"home-settings","message_template":"test(home): add regression tests for avatar src guard","breaking":false},"depends_on":["T2"],"estimated_minutes":30,"priority":2}],"analysis":{"risk":"low","impact":"medium","complexity":"low"},"score":0.91,"is_bound":true,"created_at":"2026-02-13T13:16:33.126Z","bound_at":"2026-02-13T13:23:17.120Z"}
