{"id":"SOL-ISS-DSC-20260213-125122-005-1","description":"将 extendedCommands 按命令域拆分并引入公共校验/转换层，降低单文件复杂度。","approach":"先拆 combat/social/storage 三类处理器和 shared 校验，再保留 extendedCommands 兼容 facade，最后用现有回归测试验证行为不变。","tasks":[{"id":"T1","title":"拆分 extendedCommands 领域处理器","scope":"hooks/gameLogic/commands","action":"Refactor","description":"把 combat/social/storage 相关 handler 从 extendedCommands.ts 迁移到分域模块。","modification_points":[{"file":"hooks/gameLogic/extendedCommands.ts","target":"现有 22 个 handler 定义","change":"迁移到分域文件并保留引用"},{"file":"hooks/gameLogic/commands/combatHandlers.ts","target":"新建模块","change":"承载战斗类处理器"},{"file":"hooks/gameLogic/commands/socialHandlers.ts","target":"新建模块","change":"承载社交/手机类处理器"},{"file":"hooks/gameLogic/commands/storageHandlers.ts","target":"新建模块","change":"承载 sheet upsert/delete 与存储处理器"}],"implementation":["按 handler 责任归类迁移函数，确保每个函数签名不变。","迁移过程保持原有返回结构 { success, error, event } 兼容。","在原文件记录迁移映射，避免调用入口丢失。"],"test":{"unit":["handler signature compatibility","domain module import integrity"],"commands":["powershell -Command \"(Get-Content hooks/gameLogic/extendedCommands.ts | Measure-Object -Line).Lines\"","npx tsc --noEmit"]},"acceptance":{"criteria":["新增分域模块不少于 3 个，且每个模块至少包含 3 个 handler。","extendedCommands.ts 行数由 4365 降至 <= 1200。"],"verification":["执行行数统计命令满足阈值。","执行 npx tsc --noEmit 返回 0。"]},"priority":1},{"id":"T2","title":"抽离公共校验与转换层并建立 facade","scope":"hooks/gameLogic","action":"Update","description":"提取重复 validate/normalize 逻辑到 shared 模块，extendedCommands.ts 仅保留 facade re-export。","modification_points":[{"file":"hooks/gameLogic/commands/sharedValidators.ts","target":"新建模块","change":"统一 schema 校验与错误格式化"},{"file":"hooks/gameLogic/commands/index.ts","target":"新建 barrel","change":"统一导出分域 handler"},{"file":"hooks/gameLogic/extendedCommands.ts","target":"兼容入口","change":"改为 facade 导出与最小胶水逻辑"}],"implementation":["提炼重复的 validateSchema + 错误信息构建流程到 sharedValidators。","在 facade 中保持 useGameLogic 的导入路径与符号名不变。","加入兼容性检查，确保 22 个 handle* 仍可被原入口引用。"],"test":{"unit":["shared validator reuse","facade API parity"],"commands":["powershell -Command \"(rg --line-number '^export function handle' hooks/gameLogic/extendedCommands.ts | Measure-Object).Count\"","npx vitest run tests/taverndb/sheetWriteHandlers.test.ts --testTimeout=60000"]},"acceptance":{"criteria":["sharedValidators 被至少 3 个分域模块复用。","facade 对外导出的 handle* 名称集合与迁移前一致（22 个）。"],"verification":["执行导出计数命令并核对 22 个符号。","执行 npx vitest run tests/taverndb/sheetWriteHandlers.test.ts --testTimeout=60000 并通过。"]},"depends_on":["T1"],"priority":1},{"id":"T3","title":"回归验证命令域拆分","scope":"tests","action":"Add","description":"补充 facade 与分域模块回归测试，验证重构后行为保持一致。","modification_points":[{"file":"tests/taverndb/sheetWriteHandlers.test.ts","target":"现有回归","change":"补充 split 后关键路径断言"},{"file":"tests/memory/logPairing.test.ts","target":"现有回归","change":"验证日志相关 handler 不回退"},{"file":"tests/gameLogic/extendedCommands.facade.test.ts","target":"新建测试","change":"验证 facade 导出与分发一致"}],"implementation":["新增 facade API 快照断言，保证导出集合稳定。","复用现有 taverndb 与 memory 测试覆盖高风险命令路径。","将拆分风险点（sheet upsert/delete、combat roll）加入断言。"],"test":{"unit":["facade export parity","sheet write regression","log pairing regression"],"commands":["npx vitest run tests/gameLogic/extendedCommands.facade.test.ts --testTimeout=60000","npx vitest run tests/taverndb/sheetWriteHandlers.test.ts tests/memory/logPairing.test.ts --testTimeout=60000","npm run build"]},"acceptance":{"criteria":["新增 facade 回归测试不少于 6 条断言。","上述 3 条测试命令全部通过且无新增失败用例。"],"verification":["执行 npx vitest run tests/gameLogic/extendedCommands.facade.test.ts --testTimeout=60000 并通过。","执行 npm run build 并通过。"]},"depends_on":["T2"],"priority":2}],"analysis":{"risk":"medium","impact":"high","complexity":"high"},"score":0.89,"is_bound":true,"created_at":"2026-02-13T13:24:09.381Z","bound_at":"2026-02-13T13:25:32.254Z"}
