{
  "id": "SOL-ISS-MEM-001-m301",
  "description": "围绕“主叙事与记忆系统彻底分离 + 异步分批并发填表 + 映射索引召回增强”设计的全局修正方案。",
  "approach": "采用 30 个可执行任务分五层推进：边界隔离、异步并发治理、schema与映射强化、检索召回增强、质量与观测闭环。所有任务均要求量化验收与可执行验证命令。",
  "tasks": [
    {
      "id": "T1",
      "title": "Hard-block story LOG writes",
      "scope": "hooks/useGameLogic.ts",
      "action": "Refactor",
      "description": "在 separate 模式且 memory 服务启用时，主叙事命令不允许写入 LOG_Summary/LOG_Outline（含 append_log_* 与 upsert_sheet_rows(LOG_*)）。",
      "modification_points": [
        {
          "file": "hooks/useGameLogic.ts",
          "target": "stripStoryTableOwnedCommands + validation gate",
          "change": "在 separate 模式且 memory 服务启用时，主叙事命令不允许写入 LOG_Summary/LOG_Outline（含 append_log_* 与 upsert_sheet_rows(LOG_*)）。"
        }
      ],
      "implementation": [
        "梳理并锁定 stripStoryTableOwnedCommands + validation gate 的当前执行路径与边界条件。",
        "实现变更：在 separate 模式且 memory 服务启用时，主叙事命令不允许写入 LOG_Summary/LOG_Outline（含 append_log_* 与 upsert_sheet_rows(LOG_*)）。",
        "补充单元测试与集成测试样例，并更新必要的调试/观测字段。"
      ],
      "test": {
        "unit": [
          "tests/memory/memoryBoundary.test.ts"
        ],
        "integration": [
          "tests/memory/memoryBoundary.integration.test.ts"
        ],
        "commands": [
          "npm test",
          "npx tsc --noEmit",
          "npm run build"
        ],
        "coverage_target": 85
      },
      "regression": [
        "主叙事 logs 输出格式保持兼容。",
        "tavern_commands 仍满足 JSON 协议与 schema 解析。"
      ],
      "acceptance": {
        "criteria": [
          "在 20 组 story 命令样例中，LOG 相关写入拦截率=100%。",
          "被拦截命令不会改变 日志摘要/日志大纲 数组长度，且写入 MEM_BOUNDARY_001 系统日志。"
        ],
        "verification": [
          "新增 tests/memory/memoryBoundary.test.ts 覆盖 append_log_summary/append_log_outline/upsert_sheet_rows(LOG_*) 三类输入。",
          "执行 npm test -- tests/memory/memoryBoundary.test.ts 与 npx tsc --noEmit 均通过。"
        ],
        "manual_checks": [
          "在 separate 模式与 unified 模式各回放至少 5 回合并检查 memory 日志与表格变化。"
        ]
      },
      "commit": {
        "type": "fix",
        "scope": "memory-boundary",
        "message_template": "fix(memory-boundary): Hard-block story LOG writes",
        "breaking": false
      },
      "depends_on": [],
      "estimated_minutes": 45,
      "priority": 1
    },
    {
      "id": "T2",
      "title": "Remove automatic summary/outline auto-fill",
      "scope": "hooks/useGameLogic.ts",
      "action": "Fix",
      "description": "移除日志配对缺失时的自动补全文本逻辑，改为显式失败并回滚，避免非 memory 服务兜底生成记忆内容。",
      "modification_points": [
        {
          "file": "hooks/useGameLogic.ts",
          "target": "applyCommandsWithTurnTransaction pairing repair block",
          "change": "移除日志配对缺失时的自动补全文本逻辑，改为显式失败并回滚，避免非 memory 服务兜底生成记忆内容。"
        }
      ],
      "implementation": [
        "梳理并锁定 applyCommandsWithTurnTransaction pairing repair block 的当前执行路径与边界条件。",
        "实现变更：移除日志配对缺失时的自动补全文本逻辑，改为显式失败并回滚，避免非 memory 服务兜底生成记忆内容。",
        "补充单元测试与集成测试样例，并更新必要的调试/观测字段。"
      ],
      "test": {
        "unit": [
          "tests/memory/pairRollback.test.ts"
        ],
        "integration": [
          "tests/memory/memoryTransaction.integration.test.ts"
        ],
        "commands": [
          "npm test",
          "npx tsc --noEmit",
          "npm run build"
        ],
        "coverage_target": 85
      },
      "regression": [
        "主叙事 logs 输出格式保持兼容。",
        "tavern_commands 仍满足 JSON 协议与 schema 解析。"
      ],
      "acceptance": {
        "criteria": [
          "出现 introducedMissingOutline 或 introducedMissingSummary 时，系统不再自动生成 fallback 纪要/大纲。",
          "配对失败批次回滚后，新增未配对 AM 数量=0。"
        ],
        "verification": [
          "新增 tests/memory/pairRollback.test.ts 覆盖 summary-only 与 outline-only 两种失败路径。",
          "执行 npm test -- tests/memory/pairRollback.test.ts 通过。"
        ],
        "manual_checks": [
          "在 separate 模式与 unified 模式各回放至少 5 回合并检查 memory 日志与表格变化。"
        ]
      },
      "commit": {
        "type": "fix",
        "scope": "memory-pairing",
        "message_template": "fix(memory-pairing): Remove automatic summary/outline auto-fill",
        "breaking": false
      },
      "depends_on": [
        "T1"
      ],
      "estimated_minutes": 40,
      "priority": 1
    },
    {
      "id": "T3",
      "title": "Enforce LOG sheet source ownership",
      "scope": "utils/taverndb/turnTransaction.ts",
      "action": "Implement",
      "description": "为 LOG_Summary/LOG_Outline 引入 source ownership，默认仅允许 source=ms:memory 提交 patch。",
      "modification_points": [
        {
          "file": "utils/taverndb/turnTransaction.ts",
          "target": "resolvePatchConflicts source gate",
          "change": "为 LOG_Summary/LOG_Outline 引入 source ownership，默认仅允许 source=ms:memory 提交 patch。"
        }
      ],
      "implementation": [
        "梳理并锁定 resolvePatchConflicts source gate 的当前执行路径与边界条件。",
        "实现变更：为 LOG_Summary/LOG_Outline 引入 source ownership，默认仅允许 source=ms:memory 提交 patch。",
        "补充单元测试与集成测试样例，并更新必要的调试/观测字段。"
      ],
      "test": {
        "unit": [
          "tests/memory/logSourceOwnership.test.ts"
        ],
        "integration": [
          "tests/memory/tableConflict.integration.test.ts"
        ],
        "commands": [
          "npm test",
          "npx tsc --noEmit",
          "npm run build"
        ],
        "coverage_target": 85
      },
      "regression": [
        "主叙事 logs 输出格式保持兼容。",
        "tavern_commands 仍满足 JSON 协议与 schema 解析。"
      ],
      "acceptance": {
        "criteria": [
          "非 ms:memory 来源写入 LOG_* 时冲突拦截率=100%。",
          "被拒绝写入在 SYS_ValidationIssue 记录 source_not_allowed 原因。"
        ],
        "verification": [
          "新增 tests/memory/logSourceOwnership.test.ts 验证 source 白名单。",
          "执行 npm test -- tests/memory/logSourceOwnership.test.ts 与 npm run build 通过。"
        ],
        "manual_checks": [
          "在 separate 模式与 unified 模式各回放至少 5 回合并检查 memory 日志与表格变化。"
        ]
      },
      "commit": {
        "type": "fix",
        "scope": "memory-ownership",
        "message_template": "fix(memory-ownership): Enforce LOG sheet source ownership",
        "breaking": false
      },
      "depends_on": [
        "T1"
      ],
      "estimated_minutes": 50,
      "priority": 1
    },
    {
      "id": "T4",
      "title": "Isolate memory fallback from story path",
      "scope": "hooks/useGameLogic.ts",
      "action": "Refactor",
      "description": "确保记忆填表失败时仅由 memory worker 处理降级，不从主叙事输出或通用路径推导记忆字段。",
      "modification_points": [
        {
          "file": "hooks/useGameLogic.ts",
          "target": "memory repair/fallback chain",
          "change": "确保记忆填表失败时仅由 memory worker 处理降级，不从主叙事输出或通用路径推导记忆字段。"
        }
      ],
      "implementation": [
        "梳理并锁定 memory repair/fallback chain 的当前执行路径与边界条件。",
        "实现变更：确保记忆填表失败时仅由 memory worker 处理降级，不从主叙事输出或通用路径推导记忆字段。",
        "补充单元测试与集成测试样例，并更新必要的调试/观测字段。"
      ],
      "test": {
        "unit": [
          "tests/memory/degradePolicy.test.ts"
        ],
        "integration": [
          "tests/memory/degradePolicy.integration.test.ts"
        ],
        "commands": [
          "npm test",
          "npx tsc --noEmit",
          "npm run build"
        ],
        "coverage_target": 85
      },
      "regression": [
        "主叙事 logs 输出格式保持兼容。",
        "tavern_commands 仍满足 JSON 协议与 schema 解析。"
      ],
      "acceptance": {
        "criteria": [
          "memory API 失败场景下，不触发主叙事命令补写 LOG_*。",
          "失败时仅产出 memory-degraded 状态日志，不写入伪造纪要文本。"
        ],
        "verification": [
          "新增 tests/memory/degradePolicy.test.ts 覆盖 timeout/empty/parse-error 三类。",
          "执行 npm test -- tests/memory/degradePolicy.test.ts 通过。"
        ],
        "manual_checks": [
          "在 separate 模式与 unified 模式各回放至少 5 回合并检查 memory 日志与表格变化。"
        ]
      },
      "commit": {
        "type": "refactor",
        "scope": "memory-fallback",
        "message_template": "refactor(memory-fallback): Isolate memory fallback from story path",
        "breaking": false
      },
      "depends_on": [
        "T2"
      ],
      "estimated_minutes": 45,
      "priority": 1
    },
    {
      "id": "T5",
      "title": "Remove implicit state->memory endpoint fallback",
      "scope": "utils/aiDispatch.ts",
      "action": "Fix",
      "description": "移除 state 服务缺失时自动借用 memory endpoint 的策略，改为显式缺配并跳过 state 任务。",
      "modification_points": [
        {
          "file": "utils/aiDispatch.ts",
          "target": "resolveServiceConfig(state) fallback branch",
          "change": "移除 state 服务缺失时自动借用 memory endpoint 的策略，改为显式缺配并跳过 state 任务。"
        }
      ],
      "implementation": [
        "梳理并锁定 resolveServiceConfig(state) fallback branch 的当前执行路径与边界条件。",
        "实现变更：移除 state 服务缺失时自动借用 memory endpoint 的策略，改为显式缺配并跳过 state 任务。",
        "补充单元测试与集成测试样例，并更新必要的调试/观测字段。"
      ],
      "test": {
        "unit": [
          "tests/services/stateConfigResolution.test.ts"
        ],
        "integration": [
          "tests/services/serviceRouting.integration.test.ts"
        ],
        "commands": [
          "npm test",
          "npx tsc --noEmit",
          "npm run build"
        ],
        "coverage_target": 85
      },
      "regression": [
        "主叙事 logs 输出格式保持兼容。",
        "tavern_commands 仍满足 JSON 协议与 schema 解析。"
      ],
      "acceptance": {
        "criteria": [
          "state.apiKey 为空时，不再返回 memory 配置对象。",
          "UI 与系统日志出现 STATE_SERVICE_MISSING 提示且不产生 state 写入。"
        ],
        "verification": [
          "新增 tests/services/stateConfigResolution.test.ts 覆盖 separate/unified 两模式。",
          "执行 npm test -- tests/services/stateConfigResolution.test.ts 与 npx tsc --noEmit 通过。"
        ],
        "manual_checks": [
          "在 separate 模式与 unified 模式各回放至少 5 回合并检查 memory 日志与表格变化。"
        ]
      },
      "commit": {
        "type": "fix",
        "scope": "service-routing",
        "message_template": "fix(service-routing): Remove implicit state->memory endpoint fallback",
        "breaking": false
      },
      "depends_on": [],
      "estimated_minutes": 35,
      "priority": 1
    },
    {
      "id": "T6",
      "title": "Make memory batch size configurable",
      "scope": "hooks/useGameLogic.ts",
      "action": "Configure",
      "description": "将 MEMORY_FILL_BATCH_SIZE 从硬编码常量改为 settings 配置项（建议范围 1-8），并透传到 memory worker。",
      "modification_points": [
        {
          "file": "hooks/useGameLogic.ts",
          "target": "MEMORY_FILL_BATCH_SIZE constant",
          "change": "将 MEMORY_FILL_BATCH_SIZE 从硬编码常量改为 settings 配置项（建议范围 1-8），并透传到 memory worker。"
        }
      ],
      "implementation": [
        "梳理并锁定 MEMORY_FILL_BATCH_SIZE constant 的当前执行路径与边界条件。",
        "实现变更：将 MEMORY_FILL_BATCH_SIZE 从硬编码常量改为 settings 配置项（建议范围 1-8），并透传到 memory worker。",
        "补充单元测试与集成测试样例，并更新必要的调试/观测字段。"
      ],
      "test": {
        "unit": [
          "tests/memory/memoryBatchConfig.test.ts"
        ],
        "integration": [
          "tests/memory/memoryBatchFlow.integration.test.ts"
        ],
        "commands": [
          "npm test",
          "npx tsc --noEmit",
          "npm run build"
        ],
        "coverage_target": 85
      },
      "regression": [
        "主叙事 logs 输出格式保持兼容。",
        "tavern_commands 仍满足 JSON 协议与 schema 解析。"
      ],
      "acceptance": {
        "criteria": [
          "配置项 memoryBatchSize 支持 1-8，越界自动钳制。",
          "配置修改后 1 回合内生效，调试日志显示新 batch 值。"
        ],
        "verification": [
          "新增 tests/memory/memoryBatchConfig.test.ts 覆盖边界值 0/1/8/12。",
          "执行 npm test -- tests/memory/memoryBatchConfig.test.ts 通过。"
        ],
        "manual_checks": [
          "在 separate 模式与 unified 模式各回放至少 5 回合并检查 memory 日志与表格变化。"
        ]
      },
      "commit": {
        "type": "feat",
        "scope": "memory-batch",
        "message_template": "feat(memory-batch): Make memory batch size configurable",
        "breaking": false
      },
      "depends_on": [
        "T4"
      ],
      "estimated_minutes": 35,
      "priority": 2
    },
    {
      "id": "T7",
      "title": "Add adaptive batch policy",
      "scope": "hooks/useGameLogic.ts",
      "action": "Implement",
      "description": "引入基于队列深度与延迟的自适应 batch 策略，降低峰值请求风暴。",
      "modification_points": [
        {
          "file": "hooks/useGameLogic.ts",
          "target": "flushMemoryFillJobs scheduler",
          "change": "引入基于队列深度与延迟的自适应 batch 策略，降低峰值请求风暴。"
        }
      ],
      "implementation": [
        "梳理并锁定 flushMemoryFillJobs scheduler 的当前执行路径与边界条件。",
        "实现变更：引入基于队列深度与延迟的自适应 batch 策略，降低峰值请求风暴。",
        "补充单元测试与集成测试样例，并更新必要的调试/观测字段。"
      ],
      "test": {
        "unit": [
          "tests/memory/adaptiveBatchPolicy.test.ts"
        ],
        "integration": [
          "tests/memory/adaptiveBatch.integration.test.ts"
        ],
        "commands": [
          "npm test",
          "npx tsc --noEmit",
          "npm run build"
        ],
        "coverage_target": 85
      },
      "regression": [
        "主叙事 logs 输出格式保持兼容。",
        "tavern_commands 仍满足 JSON 协议与 schema 解析。"
      ],
      "acceptance": {
        "criteria": [
          "pending>=12 时批大小至少提高 1 档；pending<=3 时恢复基线。",
          "压测 200 回合下 memory API 请求总数下降>=20%。"
        ],
        "verification": [
          "新增 tests/memory/adaptiveBatchPolicy.test.ts 模拟队列深度变化。",
          "执行 npm test -- tests/memory/adaptiveBatchPolicy.test.ts 并记录压测日志。"
        ],
        "manual_checks": [
          "在 separate 模式与 unified 模式各回放至少 5 回合并检查 memory 日志与表格变化。"
        ]
      },
      "commit": {
        "type": "feat",
        "scope": "memory-batch",
        "message_template": "feat(memory-batch): Add adaptive batch policy",
        "breaking": false
      },
      "depends_on": [
        "T6"
      ],
      "estimated_minutes": 50,
      "priority": 2
    },
    {
      "id": "T8",
      "title": "Per-sheet parallel generation with serial commit",
      "scope": "hooks/useGameLogic.ts",
      "action": "Refactor",
      "description": "保留 Summary/Outline 并发生成，但提交阶段按 turn 升序串行并加事务边界。",
      "modification_points": [
        {
          "file": "hooks/useGameLogic.ts",
          "target": "runMemoryParallelBySheet",
          "change": "保留 Summary/Outline 并发生成，但提交阶段按 turn 升序串行并加事务边界。"
        }
      ],
      "implementation": [
        "梳理并锁定 runMemoryParallelBySheet 的当前执行路径与边界条件。",
        "实现变更：保留 Summary/Outline 并发生成，但提交阶段按 turn 升序串行并加事务边界。",
        "补充单元测试与集成测试样例，并更新必要的调试/观测字段。"
      ],
      "test": {
        "unit": [
          "tests/memory/parallelCommitOrder.test.ts"
        ],
        "integration": [
          "tests/memory/parallelCommit.integration.test.ts"
        ],
        "commands": [
          "npm test",
          "npx tsc --noEmit",
          "npm run build"
        ],
        "coverage_target": 85
      },
      "regression": [
        "主叙事 logs 输出格式保持兼容。",
        "tavern_commands 仍满足 JSON 协议与 schema 解析。"
      ],
      "acceptance": {
        "criteria": [
          "并发生成模式下 100 回合测试无交叉写入冲突。",
          "提交顺序严格按 turn 升序，逆序提交次数=0。"
        ],
        "verification": [
          "新增 tests/memory/parallelCommitOrder.test.ts 验证并发生成与串行提交。",
          "执行 npm test -- tests/memory/parallelCommitOrder.test.ts 通过。"
        ],
        "manual_checks": [
          "在 separate 模式与 unified 模式各回放至少 5 回合并检查 memory 日志与表格变化。"
        ]
      },
      "commit": {
        "type": "refactor",
        "scope": "memory-parallel",
        "message_template": "refactor(memory-parallel): Per-sheet parallel generation with serial commit",
        "breaking": false
      },
      "depends_on": [
        "T2",
        "T3"
      ],
      "estimated_minutes": 55,
      "priority": 1
    },
    {
      "id": "T9",
      "title": "Add idempotency dedupe key",
      "scope": "hooks/useGameLogic.ts",
      "action": "Implement",
      "description": "对 memory 批任务引入 idempotency key（turn+sheet+am）去重，避免重试导致重复入表。",
      "modification_points": [
        {
          "file": "hooks/useGameLogic.ts",
          "target": "memory job enqueue + commit dedupe",
          "change": "对 memory 批任务引入 idempotency key（turn+sheet+am）去重，避免重试导致重复入表。"
        }
      ],
      "implementation": [
        "梳理并锁定 memory job enqueue + commit dedupe 的当前执行路径与边界条件。",
        "实现变更：对 memory 批任务引入 idempotency key（turn+sheet+am）去重，避免重试导致重复入表。",
        "补充单元测试与集成测试样例，并更新必要的调试/观测字段。"
      ],
      "test": {
        "unit": [
          "tests/memory/idempotencyKey.test.ts"
        ],
        "integration": [
          "tests/memory/idempotency.integration.test.ts"
        ],
        "commands": [
          "npm test",
          "npx tsc --noEmit",
          "npm run build"
        ],
        "coverage_target": 85
      },
      "regression": [
        "主叙事 logs 输出格式保持兼容。",
        "tavern_commands 仍满足 JSON 协议与 schema 解析。"
      ],
      "acceptance": {
        "criteria": [
          "同 key 重放 50 次，最终新增行数=1。",
          "去重命中可观测，dedupe_hit_count 指标>0。"
        ],
        "verification": [
          "新增 tests/memory/idempotencyKey.test.ts 覆盖重复提交。",
          "执行 npm test -- tests/memory/idempotencyKey.test.ts 通过。"
        ],
        "manual_checks": [
          "在 separate 模式与 unified 模式各回放至少 5 回合并检查 memory 日志与表格变化。"
        ]
      },
      "commit": {
        "type": "feat",
        "scope": "memory-idempotency",
        "message_template": "feat(memory-idempotency): Add idempotency dedupe key",
        "breaking": false
      },
      "depends_on": [
        "T8"
      ],
      "estimated_minutes": 40,
      "priority": 1
    },
    {
      "id": "T10",
      "title": "Add retry with exponential backoff",
      "scope": "hooks/useGameLogic.ts",
      "action": "Implement",
      "description": "为 memory 服务增加有上限的指数退避重试和错误分类。",
      "modification_points": [
        {
          "file": "hooks/useGameLogic.ts",
          "target": "enqueueMicroserviceTask(memory) retry flow",
          "change": "为 memory 服务增加有上限的指数退避重试和错误分类。"
        }
      ],
      "implementation": [
        "梳理并锁定 enqueueMicroserviceTask(memory) retry flow 的当前执行路径与边界条件。",
        "实现变更：为 memory 服务增加有上限的指数退避重试和错误分类。",
        "补充单元测试与集成测试样例，并更新必要的调试/观测字段。"
      ],
      "test": {
        "unit": [
          "tests/memory/retryBackoff.test.ts"
        ],
        "integration": [
          "tests/memory/retryBackoff.integration.test.ts"
        ],
        "commands": [
          "npm test",
          "npx tsc --noEmit",
          "npm run build"
        ],
        "coverage_target": 85
      },
      "regression": [
        "主叙事 logs 输出格式保持兼容。",
        "tavern_commands 仍满足 JSON 协议与 schema 解析。"
      ],
      "acceptance": {
        "criteria": [
          "单任务最大重试次数=3，退避序列约 200/600/1800ms。",
          "达到上限后任务进入失败状态并保留错误码。"
        ],
        "verification": [
          "新增 tests/memory/retryBackoff.test.ts 验证退避与封顶。",
          "执行 npm test -- tests/memory/retryBackoff.test.ts 通过。"
        ],
        "manual_checks": [
          "在 separate 模式与 unified 模式各回放至少 5 回合并检查 memory 日志与表格变化。"
        ]
      },
      "commit": {
        "type": "feat",
        "scope": "memory-retry",
        "message_template": "feat(memory-retry): Add retry with exponential backoff",
        "breaking": false
      },
      "depends_on": [
        "T13"
      ],
      "estimated_minutes": 45,
      "priority": 2
    },
    {
      "id": "T11",
      "title": "Add pending queue cap and backpressure",
      "scope": "hooks/useGameLogic.ts",
      "action": "Fix",
      "description": "增加 memory pending 队列上限与背压策略，防止长时运行内存膨胀。",
      "modification_points": [
        {
          "file": "hooks/useGameLogic.ts",
          "target": "memoryFillJobsRef queue management",
          "change": "增加 memory pending 队列上限与背压策略，防止长时运行内存膨胀。"
        }
      ],
      "implementation": [
        "梳理并锁定 memoryFillJobsRef queue management 的当前执行路径与边界条件。",
        "实现变更：增加 memory pending 队列上限与背压策略，防止长时运行内存膨胀。",
        "补充单元测试与集成测试样例，并更新必要的调试/观测字段。"
      ],
      "test": {
        "unit": [
          "tests/memory/backpressure.test.ts"
        ],
        "integration": [
          "tests/memory/backpressure.integration.test.ts"
        ],
        "commands": [
          "npm test",
          "npx tsc --noEmit",
          "npm run build"
        ],
        "coverage_target": 85
      },
      "regression": [
        "主叙事 logs 输出格式保持兼容。",
        "tavern_commands 仍满足 JSON 协议与 schema 解析。"
      ],
      "acceptance": {
        "criteria": [
          "pending 队列默认上限=24，可配置。",
          "500 次连续入队测试中，队列长度不会超过上限且内存增长<15%。"
        ],
        "verification": [
          "新增 tests/memory/backpressure.test.ts 覆盖超限与合并策略。",
          "执行 npm test -- tests/memory/backpressure.test.ts 通过。"
        ],
        "manual_checks": [
          "在 separate 模式与 unified 模式各回放至少 5 回合并检查 memory 日志与表格变化。"
        ]
      },
      "commit": {
        "type": "fix",
        "scope": "memory-queue",
        "message_template": "fix(memory-queue): Add pending queue cap and backpressure",
        "breaking": false
      },
      "depends_on": [
        "T6"
      ],
      "estimated_minutes": 35,
      "priority": 2
    },
    {
      "id": "T12",
      "title": "Check stale snapshot before commit",
      "scope": "hooks/useGameLogic.ts",
      "action": "Implement",
      "description": "memory 提交前校验 snapshot 版本，过期快照重排或丢弃，避免旧状态覆盖新数据。",
      "modification_points": [
        {
          "file": "hooks/useGameLogic.ts",
          "target": "memory commit expectedSheetVersion gate",
          "change": "memory 提交前校验 snapshot 版本，过期快照重排或丢弃，避免旧状态覆盖新数据。"
        }
      ],
      "implementation": [
        "梳理并锁定 memory commit expectedSheetVersion gate 的当前执行路径与边界条件。",
        "实现变更：memory 提交前校验 snapshot 版本，过期快照重排或丢弃，避免旧状态覆盖新数据。",
        "补充单元测试与集成测试样例，并更新必要的调试/观测字段。"
      ],
      "test": {
        "unit": [
          "tests/memory/staleSnapshotGuard.test.ts"
        ],
        "integration": [
          "tests/memory/versionGuard.integration.test.ts"
        ],
        "commands": [
          "npm test",
          "npx tsc --noEmit",
          "npm run build"
        ],
        "coverage_target": 85
      },
      "regression": [
        "主叙事 logs 输出格式保持兼容。",
        "tavern_commands 仍满足 JSON 协议与 schema 解析。"
      ],
      "acceptance": {
        "criteria": [
          "版本不一致提交被拒绝率=100%。",
          "并发冲突回放中误覆盖次数=0。"
        ],
        "verification": [
          "新增 tests/memory/staleSnapshotGuard.test.ts 模拟并发版本漂移。",
          "执行 npm test -- tests/memory/staleSnapshotGuard.test.ts 通过。"
        ],
        "manual_checks": [
          "在 separate 模式与 unified 模式各回放至少 5 回合并检查 memory 日志与表格变化。"
        ]
      },
      "commit": {
        "type": "fix",
        "scope": "memory-consistency",
        "message_template": "fix(memory-consistency): Check stale snapshot before commit",
        "breaking": false
      },
      "depends_on": [
        "T8",
        "T9"
      ],
      "estimated_minutes": 45,
      "priority": 1
    },
    {
      "id": "T13",
      "title": "Introduce memory failure reason taxonomy",
      "scope": "hooks/useGameLogic.ts",
      "action": "Update",
      "description": "统一 memory 失败原因码，覆盖 parse/schema/pair/api/timeout/empty 等场景，便于观测和自动恢复。",
      "modification_points": [
        {
          "file": "hooks/useGameLogic.ts",
          "target": "memory repairNote/error mapping",
          "change": "统一 memory 失败原因码，覆盖 parse/schema/pair/api/timeout/empty 等场景，便于观测和自动恢复。"
        }
      ],
      "implementation": [
        "梳理并锁定 memory repairNote/error mapping 的当前执行路径与边界条件。",
        "实现变更：统一 memory 失败原因码，覆盖 parse/schema/pair/api/timeout/empty 等场景，便于观测和自动恢复。",
        "补充单元测试与集成测试样例，并更新必要的调试/观测字段。"
      ],
      "test": {
        "unit": [
          "tests/memory/failureReasonCodes.test.ts"
        ],
        "integration": [
          "tests/memory/failureReason.integration.test.ts"
        ],
        "commands": [
          "npm test",
          "npx tsc --noEmit",
          "npm run build"
        ],
        "coverage_target": 85
      },
      "regression": [
        "主叙事 logs 输出格式保持兼容。",
        "tavern_commands 仍满足 JSON 协议与 schema 解析。"
      ],
      "acceptance": {
        "criteria": [
          "失败码枚举至少包含 6 类：parse_error/schema_invalid/pair_mismatch/api_timeout/api_error/empty_response。",
          "95%失败日志可映射到枚举原因。"
        ],
        "verification": [
          "新增 tests/memory/failureReasonCodes.test.ts 覆盖各类异常。",
          "执行 npm test -- tests/memory/failureReasonCodes.test.ts 通过。"
        ],
        "manual_checks": [
          "在 separate 模式与 unified 模式各回放至少 5 回合并检查 memory 日志与表格变化。"
        ]
      },
      "commit": {
        "type": "refactor",
        "scope": "memory-observability",
        "message_template": "refactor(memory-observability): Introduce memory failure reason taxonomy",
        "breaking": false
      },
      "depends_on": [],
      "estimated_minutes": 30,
      "priority": 2
    },
    {
      "id": "T14",
      "title": "Add circuit breaker for memory service",
      "scope": "hooks/useGameLogic.ts",
      "action": "Implement",
      "description": "连续失败触发熔断，熔断期间暂停外发请求并落地降级状态。",
      "modification_points": [
        {
          "file": "hooks/useGameLogic.ts",
          "target": "memory service task gate",
          "change": "连续失败触发熔断，熔断期间暂停外发请求并落地降级状态。"
        }
      ],
      "implementation": [
        "梳理并锁定 memory service task gate 的当前执行路径与边界条件。",
        "实现变更：连续失败触发熔断，熔断期间暂停外发请求并落地降级状态。",
        "补充单元测试与集成测试样例，并更新必要的调试/观测字段。"
      ],
      "test": {
        "unit": [
          "tests/memory/circuitBreaker.test.ts"
        ],
        "integration": [
          "tests/memory/circuitBreaker.integration.test.ts"
        ],
        "commands": [
          "npm test",
          "npx tsc --noEmit",
          "npm run build"
        ],
        "coverage_target": 85
      },
      "regression": [
        "主叙事 logs 输出格式保持兼容。",
        "tavern_commands 仍满足 JSON 协议与 schema 解析。"
      ],
      "acceptance": {
        "criteria": [
          "连续 5 次失败触发 30 秒熔断。",
          "熔断期内 memory API 请求数=0，恢复后首个成功请求可自动闭环。"
        ],
        "verification": [
          "新增 tests/memory/circuitBreaker.test.ts 验证开关行为。",
          "执行 npm test -- tests/memory/circuitBreaker.test.ts 通过。"
        ],
        "manual_checks": [
          "在 separate 模式与 unified 模式各回放至少 5 回合并检查 memory 日志与表格变化。"
        ]
      },
      "commit": {
        "type": "feat",
        "scope": "memory-resilience",
        "message_template": "feat(memory-resilience): Add circuit breaker for memory service",
        "breaking": false
      },
      "depends_on": [
        "T13"
      ],
      "estimated_minutes": 45,
      "priority": 2
    },
    {
      "id": "T15",
      "title": "Add dead-letter queue for failed memory jobs",
      "scope": "hooks/useGameLogic.ts",
      "action": "Add",
      "description": "超过重试上限的 memory job 写入 dead-letter 队列，支持后续手动 replay。",
      "modification_points": [
        {
          "file": "hooks/useGameLogic.ts",
          "target": "memory failure persistence",
          "change": "超过重试上限的 memory job 写入 dead-letter 队列，支持后续手动 replay。"
        }
      ],
      "implementation": [
        "梳理并锁定 memory failure persistence 的当前执行路径与边界条件。",
        "实现变更：超过重试上限的 memory job 写入 dead-letter 队列，支持后续手动 replay。",
        "补充单元测试与集成测试样例，并更新必要的调试/观测字段。"
      ],
      "test": {
        "unit": [
          "tests/memory/deadLetterQueue.test.ts"
        ],
        "integration": [
          "tests/memory/deadLetter.integration.test.ts"
        ],
        "commands": [
          "npm test",
          "npx tsc --noEmit",
          "npm run build"
        ],
        "coverage_target": 85
      },
      "regression": [
        "主叙事 logs 输出格式保持兼容。",
        "tavern_commands 仍满足 JSON 协议与 schema 解析。"
      ],
      "acceptance": {
        "criteria": [
          "失败任务 100% 进入 dead-letter 存储并带 job_id/turn/error_code。",
          "提供 replay 接口后，回放成功率可统计且可追踪。"
        ],
        "verification": [
          "新增 tests/memory/deadLetterQueue.test.ts 覆盖入队与重放。",
          "执行 npm test -- tests/memory/deadLetterQueue.test.ts 通过。"
        ],
        "manual_checks": [
          "在 separate 模式与 unified 模式各回放至少 5 回合并检查 memory 日志与表格变化。"
        ]
      },
      "commit": {
        "type": "feat",
        "scope": "memory-recovery",
        "message_template": "feat(memory-recovery): Add dead-letter queue for failed memory jobs",
        "breaking": false
      },
      "depends_on": [
        "T10",
        "T14"
      ],
      "estimated_minutes": 40,
      "priority": 2
    },
    {
      "id": "T16",
      "title": "Strengthen LogSummary schema constraints",
      "scope": "utils/contracts.ts",
      "action": "Update",
      "description": "为 LogSummary 增加时间跨度必填、纪要最小长度、编码索引格式约束。",
      "modification_points": [
        {
          "file": "utils/contracts.ts",
          "target": "LogSummarySchema + handler validation",
          "change": "为 LogSummary 增加时间跨度必填、纪要最小长度、编码索引格式约束。"
        }
      ],
      "implementation": [
        "梳理并锁定 LogSummarySchema + handler validation 的当前执行路径与边界条件。",
        "实现变更：为 LogSummary 增加时间跨度必填、纪要最小长度、编码索引格式约束。",
        "补充单元测试与集成测试样例，并更新必要的调试/观测字段。"
      ],
      "test": {
        "unit": [
          "tests/memory/logSummarySchema.test.ts"
        ],
        "integration": [
          "tests/memory/logSchema.integration.test.ts"
        ],
        "commands": [
          "npm test",
          "npx tsc --noEmit",
          "npm run build"
        ],
        "coverage_target": 85
      },
      "regression": [
        "主叙事 logs 输出格式保持兼容。",
        "tavern_commands 仍满足 JSON 协议与 schema 解析。"
      ],
      "acceptance": {
        "criteria": [
          "纪要长度<200字 payload 拒绝率=100%。",
          "编码索引不匹配 AMxxxx 时拒绝率=100%。"
        ],
        "verification": [
          "新增 tests/memory/logSummarySchema.test.ts 覆盖长度和格式校验。",
          "执行 npm test -- tests/memory/logSummarySchema.test.ts 与 npx tsc --noEmit 通过。"
        ],
        "manual_checks": [
          "在 separate 模式与 unified 模式各回放至少 5 回合并检查 memory 日志与表格变化。"
        ]
      },
      "commit": {
        "type": "fix",
        "scope": "memory-schema",
        "message_template": "fix(memory-schema): Strengthen LogSummary schema constraints",
        "breaking": false
      },
      "depends_on": [],
      "estimated_minutes": 35,
      "priority": 1
    },
    {
      "id": "T17",
      "title": "Add outline anti-homogeneous hard gate",
      "scope": "hooks/useGameLogic.ts",
      "action": "Fix",
      "description": "统一 summary-outline 相似度阈值并在提交前硬拒绝同质化内容。",
      "modification_points": [
        {
          "file": "hooks/useGameLogic.ts",
          "target": "isSummaryOutlineOverHomogeneous threshold",
          "change": "统一 summary-outline 相似度阈值并在提交前硬拒绝同质化内容。"
        }
      ],
      "implementation": [
        "梳理并锁定 isSummaryOutlineOverHomogeneous threshold 的当前执行路径与边界条件。",
        "实现变更：统一 summary-outline 相似度阈值并在提交前硬拒绝同质化内容。",
        "补充单元测试与集成测试样例，并更新必要的调试/观测字段。"
      ],
      "test": {
        "unit": [
          "tests/memory/outlineHomogeneousGuard.test.ts"
        ],
        "integration": [
          "tests/memory/quality.integration.test.ts"
        ],
        "commands": [
          "npm test",
          "npx tsc --noEmit",
          "npm run build"
        ],
        "coverage_target": 85
      },
      "regression": [
        "主叙事 logs 输出格式保持兼容。",
        "tavern_commands 仍满足 JSON 协议与 schema 解析。"
      ],
      "acceptance": {
        "criteria": [
          "summary-outline 相似度阈值<=0.75。",
          "抽样 100 组回放中重复率<=5%。"
        ],
        "verification": [
          "新增 tests/memory/outlineHomogeneousGuard.test.ts 覆盖边界样本。",
          "执行 npm test -- tests/memory/outlineHomogeneousGuard.test.ts 通过。"
        ],
        "manual_checks": [
          "在 separate 模式与 unified 模式各回放至少 5 回合并检查 memory 日志与表格变化。"
        ]
      },
      "commit": {
        "type": "fix",
        "scope": "memory-quality",
        "message_template": "fix(memory-quality): Add outline anti-homogeneous hard gate",
        "breaking": false
      },
      "depends_on": [
        "T16"
      ],
      "estimated_minutes": 30,
      "priority": 1
    },
    {
      "id": "T18",
      "title": "Enforce mapping registry for memory domains",
      "scope": "utils/taverndb/sheetRegistry.ts",
      "action": "Implement",
      "description": "将 LOG_Summary/LOG_Outline/NPC_InteractionLog 映射注册为强约束，未知映射拒绝写入。",
      "modification_points": [
        {
          "file": "utils/taverndb/sheetRegistry.ts",
          "target": "getDomainMappingRegistry + startup check",
          "change": "将 LOG_Summary/LOG_Outline/NPC_InteractionLog 映射注册为强约束，未知映射拒绝写入。"
        }
      ],
      "implementation": [
        "梳理并锁定 getDomainMappingRegistry + startup check 的当前执行路径与边界条件。",
        "实现变更：将 LOG_Summary/LOG_Outline/NPC_InteractionLog 映射注册为强约束，未知映射拒绝写入。",
        "补充单元测试与集成测试样例，并更新必要的调试/观测字段。"
      ],
      "test": {
        "unit": [
          "tests/taverndb/mappingRegistryGuard.test.ts"
        ],
        "integration": [
          "tests/taverndb/mappingRegistry.integration.test.ts"
        ],
        "commands": [
          "npm test",
          "npx tsc --noEmit",
          "npm run build"
        ],
        "coverage_target": 85
      },
      "regression": [
        "主叙事 logs 输出格式保持兼容。",
        "tavern_commands 仍满足 JSON 协议与 schema 解析。"
      ],
      "acceptance": {
        "criteria": [
          "启动时映射表缺失关键域会触发 fatal 配置错误。",
          "未知 sheet/domain 写入被拒绝率=100%。"
        ],
        "verification": [
          "新增 tests/taverndb/mappingRegistryGuard.test.ts 覆盖缺失映射和未知域。",
          "执行 npm test -- tests/taverndb/mappingRegistryGuard.test.ts 通过。"
        ],
        "manual_checks": [
          "在 separate 模式与 unified 模式各回放至少 5 回合并检查 memory 日志与表格变化。"
        ]
      },
      "commit": {
        "type": "feat",
        "scope": "mapping-registry",
        "message_template": "feat(mapping-registry): Enforce mapping registry for memory domains",
        "breaking": false
      },
      "depends_on": [],
      "estimated_minutes": 40,
      "priority": 1
    },
    {
      "id": "T19",
      "title": "Persist monotonic AM allocator state",
      "scope": "utils/memory/amIndex.ts",
      "action": "Refactor",
      "description": "AM 分配加入持久游标与 max(existing) 双保险，防止回档/重放造成重复。",
      "modification_points": [
        {
          "file": "utils/memory/amIndex.ts",
          "target": "assignAmIndexesForLogCommands allocator",
          "change": "AM 分配加入持久游标与 max(existing) 双保险，防止回档/重放造成重复。"
        }
      ],
      "implementation": [
        "梳理并锁定 assignAmIndexesForLogCommands allocator 的当前执行路径与边界条件。",
        "实现变更：AM 分配加入持久游标与 max(existing) 双保险，防止回档/重放造成重复。",
        "补充单元测试与集成测试样例，并更新必要的调试/观测字段。"
      ],
      "test": {
        "unit": [
          "tests/memory/amAllocatorMonotonic.test.ts"
        ],
        "integration": [
          "tests/memory/amAllocator.integration.test.ts"
        ],
        "commands": [
          "npm test",
          "npx tsc --noEmit",
          "npm run build"
        ],
        "coverage_target": 85
      },
      "regression": [
        "主叙事 logs 输出格式保持兼容。",
        "tavern_commands 仍满足 JSON 协议与 schema 解析。"
      ],
      "acceptance": {
        "criteria": [
          "1000 回合重放中 AM 重复数=0。",
          "AM 序列单调递增断言通过率=100%。"
        ],
        "verification": [
          "新增 tests/memory/amAllocatorMonotonic.test.ts 覆盖回档与重放。",
          "执行 npm test -- tests/memory/amAllocatorMonotonic.test.ts 通过。"
        ],
        "manual_checks": [
          "在 separate 模式与 unified 模式各回放至少 5 回合并检查 memory 日志与表格变化。"
        ]
      },
      "commit": {
        "type": "fix",
        "scope": "am-index",
        "message_template": "fix(am-index): Persist monotonic AM allocator state",
        "breaking": false
      },
      "depends_on": [
        "T16"
      ],
      "estimated_minutes": 45,
      "priority": 1
    },
    {
      "id": "T20",
      "title": "Add AM duplicate/gap scanner and repair",
      "scope": "utils/memory/amIndex.ts",
      "action": "Add",
      "description": "新增 AM duplicate/gap 扫描与修复建议接口，支持批次结束后自动体检。",
      "modification_points": [
        {
          "file": "utils/memory/amIndex.ts",
          "target": "collectIndexedLogPairingIssues extension",
          "change": "新增 AM duplicate/gap 扫描与修复建议接口，支持批次结束后自动体检。"
        }
      ],
      "implementation": [
        "梳理并锁定 collectIndexedLogPairingIssues extension 的当前执行路径与边界条件。",
        "实现变更：新增 AM duplicate/gap 扫描与修复建议接口，支持批次结束后自动体检。",
        "补充单元测试与集成测试样例，并更新必要的调试/观测字段。"
      ],
      "test": {
        "unit": [
          "tests/memory/amGapScanner.test.ts"
        ],
        "integration": [
          "tests/memory/amGapScanner.integration.test.ts"
        ],
        "commands": [
          "npm test",
          "npx tsc --noEmit",
          "npm run build"
        ],
        "coverage_target": 85
      },
      "regression": [
        "主叙事 logs 输出格式保持兼容。",
        "tavern_commands 仍满足 JSON 协议与 schema 解析。"
      ],
      "acceptance": {
        "criteria": [
          "每轮扫描输出 duplicate_count/gap_count 指标。",
          "可修复 gap 样例中自动修复成功率>=95%。"
        ],
        "verification": [
          "新增 tests/memory/amGapScanner.test.ts 覆盖 duplicate/gap 场景。",
          "执行 npm test -- tests/memory/amGapScanner.test.ts 通过。"
        ],
        "manual_checks": [
          "在 separate 模式与 unified 模式各回放至少 5 回合并检查 memory 日志与表格变化。"
        ]
      },
      "commit": {
        "type": "feat",
        "scope": "am-index",
        "message_template": "feat(am-index): Add AM duplicate/gap scanner and repair",
        "breaking": false
      },
      "depends_on": [
        "T19"
      ],
      "estimated_minutes": 40,
      "priority": 2
    },
    {
      "id": "T21",
      "title": "Add retrieval profile configuration",
      "scope": "utils/aiContext.ts",
      "action": "Configure",
      "description": "将 narrative/action/phone 检索配置项显式化，支持按场景定义 topK/sheetFilter/sheetWeights。",
      "modification_points": [
        {
          "file": "utils/aiContext.ts",
          "target": "resolveTableRetrievalOptions + settings binding",
          "change": "将 narrative/action/phone 检索配置项显式化，支持按场景定义 topK/sheetFilter/sheetWeights。"
        }
      ],
      "implementation": [
        "梳理并锁定 resolveTableRetrievalOptions + settings binding 的当前执行路径与边界条件。",
        "实现变更：将 narrative/action/phone 检索配置项显式化，支持按场景定义 topK/sheetFilter/sheetWeights。",
        "补充单元测试与集成测试样例，并更新必要的调试/观测字段。"
      ],
      "test": {
        "unit": [
          "tests/memory/retrievalProfileConfig.test.ts"
        ],
        "integration": [
          "tests/memory/retrievalProfile.integration.test.ts"
        ],
        "commands": [
          "npm test",
          "npx tsc --noEmit",
          "npm run build"
        ],
        "coverage_target": 85
      },
      "regression": [
        "主叙事 logs 输出格式保持兼容。",
        "tavern_commands 仍满足 JSON 协议与 schema 解析。"
      ],
      "acceptance": {
        "criteria": [
          "三种 profile 可独立配置并在 1 回合内生效。",
          "profile 切换后 retrieval block 中 mode/topK/sheetFilter 与配置一致率=100%。"
        ],
        "verification": [
          "新增 tests/memory/retrievalProfileConfig.test.ts 覆盖三 profile。",
          "执行 npm test -- tests/memory/retrievalProfileConfig.test.ts 通过。"
        ],
        "manual_checks": [
          "在 separate 模式与 unified 模式各回放至少 5 回合并检查 memory 日志与表格变化。"
        ]
      },
      "commit": {
        "type": "feat",
        "scope": "memory-retrieval",
        "message_template": "feat(memory-retrieval): Add retrieval profile configuration",
        "breaking": false
      },
      "depends_on": [],
      "estimated_minutes": 35,
      "priority": 2
    },
    {
      "id": "T22",
      "title": "Implement query expansion for aliases and locations",
      "scope": "utils/memory/tavernTableRetriever.ts",
      "action": "Implement",
      "description": "为 NPC 别名、地点同义词、AM 变体加入查询扩展，提升召回覆盖。",
      "modification_points": [
        {
          "file": "utils/memory/tavernTableRetriever.ts",
          "target": "tokenize/query preprocessing",
          "change": "为 NPC 别名、地点同义词、AM 变体加入查询扩展，提升召回覆盖。"
        }
      ],
      "implementation": [
        "梳理并锁定 tokenize/query preprocessing 的当前执行路径与边界条件。",
        "实现变更：为 NPC 别名、地点同义词、AM 变体加入查询扩展，提升召回覆盖。",
        "补充单元测试与集成测试样例，并更新必要的调试/观测字段。"
      ],
      "test": {
        "unit": [
          "tests/memory/queryExpansion.test.ts"
        ],
        "integration": [
          "tests/memory/queryExpansion.integration.test.ts"
        ],
        "commands": [
          "npm test",
          "npx tsc --noEmit",
          "npm run build"
        ],
        "coverage_target": 85
      },
      "regression": [
        "主叙事 logs 输出格式保持兼容。",
        "tavern_commands 仍满足 JSON 协议与 schema 解析。"
      ],
      "acceptance": {
        "criteria": [
          "基准查询集命中率较改造前提升>=20%。",
          "误召回率<10%，并可通过 matchedTokens 追踪扩展词来源。"
        ],
        "verification": [
          "新增 tests/memory/queryExpansion.test.ts 覆盖 alias/synonym/AM 变体。",
          "执行 npm test -- tests/memory/queryExpansion.test.ts 通过。"
        ],
        "manual_checks": [
          "在 separate 模式与 unified 模式各回放至少 5 回合并检查 memory 日志与表格变化。"
        ]
      },
      "commit": {
        "type": "feat",
        "scope": "memory-retrieval",
        "message_template": "feat(memory-retrieval): Implement query expansion for aliases and locations",
        "breaking": false
      },
      "depends_on": [
        "T21"
      ],
      "estimated_minutes": 45,
      "priority": 2
    },
    {
      "id": "T23",
      "title": "Build hybrid scoring model for retrieval",
      "scope": "utils/memory/tavernTableRetriever.ts",
      "action": "Refactor",
      "description": "实现 AM exact + token + recency 的混合打分并输出可解释分项。",
      "modification_points": [
        {
          "file": "utils/memory/tavernTableRetriever.ts",
          "target": "retrieveTavernTableRows scoreEntry",
          "change": "实现 AM exact + token + recency 的混合打分并输出可解释分项。"
        }
      ],
      "implementation": [
        "梳理并锁定 retrieveTavernTableRows scoreEntry 的当前执行路径与边界条件。",
        "实现变更：实现 AM exact + token + recency 的混合打分并输出可解释分项。",
        "补充单元测试与集成测试样例，并更新必要的调试/观测字段。"
      ],
      "test": {
        "unit": [
          "tests/memory/hybridScoring.test.ts"
        ],
        "integration": [
          "tests/memory/hybridScoring.integration.test.ts"
        ],
        "commands": [
          "npm test",
          "npx tsc --noEmit",
          "npm run build"
        ],
        "coverage_target": 85
      },
      "regression": [
        "主叙事 logs 输出格式保持兼容。",
        "tavern_commands 仍满足 JSON 协议与 schema 解析。"
      ],
      "acceptance": {
        "criteria": [
          "benchmark 集 top1 准确率>=70%。",
          "同查询重复 10 次，排序稳定性>=95%。"
        ],
        "verification": [
          "新增 tests/memory/hybridScoring.test.ts 覆盖 AM 精确命中与文本命中。",
          "执行 npm test -- tests/memory/hybridScoring.test.ts 通过。"
        ],
        "manual_checks": [
          "在 separate 模式与 unified 模式各回放至少 5 回合并检查 memory 日志与表格变化。"
        ]
      },
      "commit": {
        "type": "refactor",
        "scope": "memory-retrieval",
        "message_template": "refactor(memory-retrieval): Build hybrid scoring model for retrieval",
        "breaking": false
      },
      "depends_on": [
        "T22"
      ],
      "estimated_minutes": 50,
      "priority": 2
    },
    {
      "id": "T24",
      "title": "Collapse near-duplicate retrieval hits",
      "scope": "utils/memory/tavernTableRetriever.ts",
      "action": "Add",
      "description": "对高相似命中结果做聚类去重，避免上下文中重复纪要挤占 token。",
      "modification_points": [
        {
          "file": "utils/memory/tavernTableRetriever.ts",
          "target": "post-ranking dedupe cluster",
          "change": "对高相似命中结果做聚类去重，避免上下文中重复纪要挤占 token。"
        }
      ],
      "implementation": [
        "梳理并锁定 post-ranking dedupe cluster 的当前执行路径与边界条件。",
        "实现变更：对高相似命中结果做聚类去重，避免上下文中重复纪要挤占 token。",
        "补充单元测试与集成测试样例，并更新必要的调试/观测字段。"
      ],
      "test": {
        "unit": [
          "tests/memory/retrievalDedupCluster.test.ts"
        ],
        "integration": [
          "tests/memory/retrievalDedup.integration.test.ts"
        ],
        "commands": [
          "npm test",
          "npx tsc --noEmit",
          "npm run build"
        ],
        "coverage_target": 85
      },
      "regression": [
        "主叙事 logs 输出格式保持兼容。",
        "tavern_commands 仍满足 JSON 协议与 schema 解析。"
      ],
      "acceptance": {
        "criteria": [
          "topK=8 时 unique hits >=6（去重后）。",
          "重复段占比<10%。"
        ],
        "verification": [
          "新增 tests/memory/retrievalDedupCluster.test.ts 覆盖近重复样本。",
          "执行 npm test -- tests/memory/retrievalDedupCluster.test.ts 通过。"
        ],
        "manual_checks": [
          "在 separate 模式与 unified 模式各回放至少 5 回合并检查 memory 日志与表格变化。"
        ]
      },
      "commit": {
        "type": "feat",
        "scope": "memory-retrieval",
        "message_template": "feat(memory-retrieval): Collapse near-duplicate retrieval hits",
        "breaking": false
      },
      "depends_on": [
        "T23"
      ],
      "estimated_minutes": 35,
      "priority": 2
    },
    {
      "id": "T25",
      "title": "Expose retrieval explanation and confidence",
      "scope": "utils/aiContext.ts",
      "action": "Update",
      "description": "为每条召回结果输出 matchedTokens/source/confidence，供主叙事使用可解释记忆引用。",
      "modification_points": [
        {
          "file": "utils/aiContext.ts",
          "target": "formatTavernTableRetrievalBlock output schema",
          "change": "为每条召回结果输出 matchedTokens/source/confidence，供主叙事使用可解释记忆引用。"
        }
      ],
      "implementation": [
        "梳理并锁定 formatTavernTableRetrievalBlock output schema 的当前执行路径与边界条件。",
        "实现变更：为每条召回结果输出 matchedTokens/source/confidence，供主叙事使用可解释记忆引用。",
        "补充单元测试与集成测试样例，并更新必要的调试/观测字段。"
      ],
      "test": {
        "unit": [
          "tests/memory/retrievalExplainability.test.ts"
        ],
        "integration": [
          "tests/memory/retrievalExplainability.integration.test.ts"
        ],
        "commands": [
          "npm test",
          "npx tsc --noEmit",
          "npm run build"
        ],
        "coverage_target": 85
      },
      "regression": [
        "主叙事 logs 输出格式保持兼容。",
        "tavern_commands 仍满足 JSON 协议与 schema 解析。"
      ],
      "acceptance": {
        "criteria": [
          "召回结果 explanation 字段覆盖率=100%。",
          "confidence 在 [0,1] 区间且排序与 score 一致。"
        ],
        "verification": [
          "新增 tests/memory/retrievalExplainability.test.ts 覆盖字段完整性。",
          "执行 npm test -- tests/memory/retrievalExplainability.test.ts 通过。"
        ],
        "manual_checks": [
          "在 separate 模式与 unified 模式各回放至少 5 回合并检查 memory 日志与表格变化。"
        ]
      },
      "commit": {
        "type": "feat",
        "scope": "memory-retrieval",
        "message_template": "feat(memory-retrieval): Expose retrieval explanation and confidence",
        "breaking": false
      },
      "depends_on": [
        "T23"
      ],
      "estimated_minutes": 30,
      "priority": 2
    },
    {
      "id": "T26",
      "title": "Emit structured KNOWN_FACTS and UNKNOWN_SLOTS",
      "scope": "utils/aiContext.ts",
      "action": "Update",
      "description": "在文本块之外增加结构化 JSON 区块，标注来源、回合、AM 索引，便于主叙事严格区分已知与未知。",
      "modification_points": [
        {
          "file": "utils/aiContext.ts",
          "target": "constructMemoryContext fact boundary block",
          "change": "在文本块之外增加结构化 JSON 区块，标注来源、回合、AM 索引，便于主叙事严格区分已知与未知。"
        }
      ],
      "implementation": [
        "梳理并锁定 constructMemoryContext fact boundary block 的当前执行路径与边界条件。",
        "实现变更：在文本块之外增加结构化 JSON 区块，标注来源、回合、AM 索引，便于主叙事严格区分已知与未知。",
        "补充单元测试与集成测试样例，并更新必要的调试/观测字段。"
      ],
      "test": {
        "unit": [
          "tests/memory/factBoundaryStructured.test.ts"
        ],
        "integration": [
          "tests/memory/factBoundary.integration.test.ts"
        ],
        "commands": [
          "npm test",
          "npx tsc --noEmit",
          "npm run build"
        ],
        "coverage_target": 85
      },
      "regression": [
        "主叙事 logs 输出格式保持兼容。",
        "tavern_commands 仍满足 JSON 协议与 schema 解析。"
      ],
      "acceptance": {
        "criteria": [
          "KNOWN_FACTS_JSON 与 UNKNOWN_SLOTS_JSON 两区块输出覆盖率=100%。",
          "每条事实包含 source/sheet/turn 至少 3 个定位字段。"
        ],
        "verification": [
          "新增 tests/memory/factBoundaryStructured.test.ts 覆盖结构与字段。",
          "执行 npm test -- tests/memory/factBoundaryStructured.test.ts 通过。"
        ],
        "manual_checks": [
          "在 separate 模式与 unified 模式各回放至少 5 回合并检查 memory 日志与表格变化。"
        ]
      },
      "commit": {
        "type": "feat",
        "scope": "fact-boundary",
        "message_template": "feat(fact-boundary): Emit structured KNOWN_FACTS and UNKNOWN_SLOTS",
        "breaking": false
      },
      "depends_on": [
        "T21"
      ],
      "estimated_minutes": 40,
      "priority": 1
    },
    {
      "id": "T27",
      "title": "Add unknown-slot hard refusal in narrative prompt",
      "scope": "prompts/logic.ts",
      "action": "Fix",
      "description": "当信息仅命中 UNKNOWN_SLOTS 时，主叙事必须输出未知/待确认表达，禁止确定性陈述。",
      "modification_points": [
        {
          "file": "prompts/logic.ts",
          "target": "unknown slot output guard",
          "change": "当信息仅命中 UNKNOWN_SLOTS 时，主叙事必须输出未知/待确认表达，禁止确定性陈述。"
        }
      ],
      "implementation": [
        "梳理并锁定 unknown slot output guard 的当前执行路径与边界条件。",
        "实现变更：当信息仅命中 UNKNOWN_SLOTS 时，主叙事必须输出未知/待确认表达，禁止确定性陈述。",
        "补充单元测试与集成测试样例，并更新必要的调试/观测字段。"
      ],
      "test": {
        "unit": [
          "tests/prompts/unknownSlotGuard.test.ts"
        ],
        "integration": [
          "tests/prompts/unknownSlotGuard.integration.test.ts"
        ],
        "commands": [
          "npm test",
          "npx tsc --noEmit",
          "npm run build"
        ],
        "coverage_target": 85
      },
      "regression": [
        "主叙事 logs 输出格式保持兼容。",
        "tavern_commands 仍满足 JSON 协议与 schema 解析。"
      ],
      "acceptance": {
        "criteria": [
          "100 轮边界回放中未知槽位误判为已知的比例<1%。",
          "违规时触发 prompt-level guard 文本并阻断确定句。"
        ],
        "verification": [
          "新增 tests/prompts/unknownSlotGuard.test.ts 覆盖 20 个反例。",
          "执行 npm test -- tests/prompts/unknownSlotGuard.test.ts 通过。"
        ],
        "manual_checks": [
          "在 separate 模式与 unified 模式各回放至少 5 回合并检查 memory 日志与表格变化。"
        ]
      },
      "commit": {
        "type": "fix",
        "scope": "fact-boundary",
        "message_template": "fix(fact-boundary): Add unknown-slot hard refusal in narrative prompt",
        "breaking": false
      },
      "depends_on": [
        "T26"
      ],
      "estimated_minutes": 35,
      "priority": 1
    },
    {
      "id": "T28",
      "title": "Add cross-sheet consistency guard",
      "scope": "hooks/useGameLogic.ts",
      "action": "Implement",
      "description": "增加经济/任务/NPC/日志跨表一致性校验（例如 ECON_Ledger 与法利变更一致）。",
      "modification_points": [
        {
          "file": "hooks/useGameLogic.ts",
          "target": "post-command invariant checks",
          "change": "增加经济/任务/NPC/日志跨表一致性校验（例如 ECON_Ledger 与法利变更一致）。"
        }
      ],
      "implementation": [
        "梳理并锁定 post-command invariant checks 的当前执行路径与边界条件。",
        "实现变更：增加经济/任务/NPC/日志跨表一致性校验（例如 ECON_Ledger 与法利变更一致）。",
        "补充单元测试与集成测试样例，并更新必要的调试/观测字段。"
      ],
      "test": {
        "unit": [
          "tests/taverndb/crossSheetConsistency.test.ts"
        ],
        "integration": [
          "tests/taverndb/crossSheetConsistency.integration.test.ts"
        ],
        "commands": [
          "npm test",
          "npx tsc --noEmit",
          "npm run build"
        ],
        "coverage_target": 85
      },
      "regression": [
        "主叙事 logs 输出格式保持兼容。",
        "tavern_commands 仍满足 JSON 协议与 schema 解析。"
      ],
      "acceptance": {
        "criteria": [
          "设计 10 组冲突样例，拦截率=100%。",
          "冲突详情写入 SYS_ValidationIssue，包含 sheet/path/message。"
        ],
        "verification": [
          "新增 tests/taverndb/crossSheetConsistency.test.ts 覆盖经济与任务冲突。",
          "执行 npm test -- tests/taverndb/crossSheetConsistency.test.ts 与 npm run build 通过。"
        ],
        "manual_checks": [
          "在 separate 模式与 unified 模式各回放至少 5 回合并检查 memory 日志与表格变化。"
        ]
      },
      "commit": {
        "type": "feat",
        "scope": "consistency-guard",
        "message_template": "feat(consistency-guard): Add cross-sheet consistency guard",
        "breaking": false
      },
      "depends_on": [
        "T3"
      ],
      "estimated_minutes": 50,
      "priority": 1
    },
    {
      "id": "T29",
      "title": "Add NPC interaction fingerprint cooldown",
      "scope": "hooks/useGameLogic.ts",
      "action": "Implement",
      "description": "按 NPC+意图+时间窗口生成指纹，对短窗口同质互动施加冷却，降低重复叙事。",
      "modification_points": [
        {
          "file": "hooks/useGameLogic.ts",
          "target": "npc interaction post-processing",
          "change": "按 NPC+意图+时间窗口生成指纹，对短窗口同质互动施加冷却，降低重复叙事。"
        }
      ],
      "implementation": [
        "梳理并锁定 npc interaction post-processing 的当前执行路径与边界条件。",
        "实现变更：按 NPC+意图+时间窗口生成指纹，对短窗口同质互动施加冷却，降低重复叙事。",
        "补充单元测试与集成测试样例，并更新必要的调试/观测字段。"
      ],
      "test": {
        "unit": [
          "tests/memory/npcInteractionCooldown.test.ts"
        ],
        "integration": [
          "tests/memory/npcInteractionCooldown.integration.test.ts"
        ],
        "commands": [
          "npm test",
          "npx tsc --noEmit",
          "npm run build"
        ],
        "coverage_target": 85
      },
      "regression": [
        "主叙事 logs 输出格式保持兼容。",
        "tavern_commands 仍满足 JSON 协议与 schema 解析。"
      ],
      "acceptance": {
        "criteria": [
          "3 回合窗口内同质互动重复率下降>=40%。",
          "冷却命中时需满足推进条件字段才允许放行。"
        ],
        "verification": [
          "新增 tests/memory/npcInteractionCooldown.test.ts 覆盖重复与推进豁免。",
          "执行 npm test -- tests/memory/npcInteractionCooldown.test.ts 通过。"
        ],
        "manual_checks": [
          "在 separate 模式与 unified 模式各回放至少 5 回合并检查 memory 日志与表格变化。"
        ]
      },
      "commit": {
        "type": "feat",
        "scope": "npc-memory",
        "message_template": "feat(npc-memory): Add NPC interaction fingerprint cooldown",
        "breaking": false
      },
      "depends_on": [
        "T24"
      ],
      "estimated_minutes": 45,
      "priority": 2
    },
    {
      "id": "T30",
      "title": "Add memory quality telemetry and SLO",
      "scope": "components/game/modals/MemoryModal.tsx",
      "action": "Add",
      "description": "新增记忆质量指标面板与 SLO 阈值告警（pair_rate/recall_hit_rate/unknown_slot_rate/retry_rate/queue_latency_p95）。",
      "modification_points": [
        {
          "file": "components/game/modals/MemoryModal.tsx",
          "target": "memory quality panel + alerts",
          "change": "新增记忆质量指标面板与 SLO 阈值告警（pair_rate/recall_hit_rate/unknown_slot_rate/retry_rate/queue_latency_p95）。"
        }
      ],
      "implementation": [
        "梳理并锁定 memory quality panel + alerts 的当前执行路径与边界条件。",
        "实现变更：新增记忆质量指标面板与 SLO 阈值告警（pair_rate/recall_hit_rate/unknown_slot_rate/retry_rate/queue_latency_p95）。",
        "补充单元测试与集成测试样例，并更新必要的调试/观测字段。"
      ],
      "test": {
        "unit": [
          "tests/ui/memoryQualityPanel.test.tsx"
        ],
        "integration": [
          "tests/ui/memoryQualityPanel.integration.test.tsx"
        ],
        "commands": [
          "npm test",
          "npx tsc --noEmit",
          "npm run build"
        ],
        "coverage_target": 85
      },
      "regression": [
        "主叙事 logs 输出格式保持兼容。",
        "tavern_commands 仍满足 JSON 协议与 schema 解析。"
      ],
      "acceptance": {
        "criteria": [
          "新增 5 项核心指标并支持最近 50 回合趋势显示。",
          "任一指标超阈值时产生系统通知与 UI 告警标记。"
        ],
        "verification": [
          "新增 tests/ui/memoryQualityPanel.test.tsx 覆盖指标渲染与告警。",
          "执行 npm test -- tests/ui/memoryQualityPanel.test.tsx 与 npm run build 通过。"
        ],
        "manual_checks": [
          "在 separate 模式与 unified 模式各回放至少 5 回合并检查 memory 日志与表格变化。"
        ]
      },
      "commit": {
        "type": "feat",
        "scope": "memory-observability",
        "message_template": "feat(memory-observability): Add memory quality telemetry and SLO",
        "breaking": false
      },
      "depends_on": [
        "T13",
        "T21",
        "T26"
      ],
      "estimated_minutes": 55,
      "priority": 2
    }
  ],
  "exploration_context": {
    "project_structure": "React + TypeScript，核心逻辑集中在 hooks/useGameLogic.ts 与 utils/memory/*、utils/taverndb/*。",
    "relevant_files": [
      "hooks/useGameLogic.ts",
      "utils/aiServices.ts",
      "utils/aiDispatch.ts",
      "utils/aiContext.ts",
      "utils/memory/amIndex.ts",
      "utils/memory/memoryRetriever.ts",
      "utils/memory/tavernTableRetriever.ts",
      "hooks/gameLogic/extendedCommands.ts",
      "utils/taverndb/sheetRegistry.ts",
      "utils/taverndb/tableProjection.ts",
      "prompts/commands.ts",
      "prompts/logic.ts",
      "docs/ref/DND仪表盘配套模板.json",
      "docs/ref/sillytavern数据库脚本.js"
    ],
    "patterns": "当前已具备 memory 异步批处理、按表并发生成、AM 配对守卫与表格检索，但仍存在主叙事兜底残留、隐式服务回退、召回可解释性不足等风险。",
    "integration_points": "微服务队列(enqueueMicroserviceTask)、命令事务(applyTurnTransaction)、表格投影(projectGameStateToTavernTables)、记忆上下文(constructMemoryContext)。"
  },
  "analysis": {
    "risk": "high",
    "impact": "high",
    "complexity": "high"
  },
  "score": 0.95,
  "is_bound": false,
  "created_at": "2026-02-13T03:00:41.6389735Z"
}
