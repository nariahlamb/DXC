# State变量灰度与发布日志（模板）

## 文档信息

- 项目：DXC
- 文档版本：v0.1
- 发布负责人：
- 开始日期：
- 对应计划：`plan/state-variable-repair-phase-checklist.md`

## 发布策略

- 阶段一：Shadow 模式（记录不拦截）
- 阶段二：Strict 模式（拦截 legacy 业务写入）
- 阶段三：收口（清理临时兼容与重复分支）

## 切换前核对

- [ ] 四服务配置检查通过（story/state/memory/map）
- [ ] `memory` 不回退校验通过
- [ ] 关键变量 MRS 校验通过
- [ ] 失败可观测性已上线
- [ ] 回滚开关与负责人已就绪

## 开关与配置快照

| 项目 | 当前值 | 目标值 | 切换时机 | 备注 |
|---|---|---|---|---|
| stateVarWriter.enabled |  |  |  |  |
| stateVarWriter.shadowMode |  |  |  |  |
| rejectNonWriterForCutoverDomains |  |  |  |  |
| strictAllowlist |  |  |  |  |

## 观测指标定义

| 指标 | 定义 | 目标 | 告警阈值 | 采样窗口 |
|---|---|---|---|---|
| 关键变量缺失率 | MRS字段缺失数/应有数 | <= 2% | > 5% | 1小时 |
| legacy拦截命中率 | 被拦截业务写入/总legacy业务写入 | 100% | < 100% | 1小时 |
| memory误路由率 | memory请求落到非memory服务比例 | 0% | > 0% | 1小时 |
| world/forum一致率 | 实际触发与配置轮次一致比例 | 100% | < 98% | 1小时 |
| 可见错误率 | 可见错误日志/失败总数 | 100% | < 95% | 1小时 |

## 每日/每轮观测记录

| 日期时间 | 发布阶段 | 总请求 | 变量写失败数 | 关键变量缺失率 | legacy拦截命中率 | memory误路由率 | world/forum一致率 | 结论 | 处理动作 |
|---|---|---:|---:|---:|---:|---:|---:|---|---|
|  | Shadow |  |  |  |  |  |  |  |  |

## 异常事件记录

| 事件ID | 时间 | 现象 | 影响范围 | 严重级别 | 根因 | 临时止血 | 长期修复 | 状态 |
|---|---|---|---|---|---|---|---|---|
| EVT-001 |  |  |  |  |  |  |  | 待处理 |

## 切换决策记录

| 决策ID | 时间 | 决策内容 | 依据指标 | 决策人 | 结果 |
|---|---|---|---|---|---|
| DEC-001 |  | Shadow -> Strict |  |  |  |

## 严格模式准入清单

- [ ] 连续观测窗口内 `memory误路由率 = 0%`
- [ ] 连续观测窗口内 `legacy拦截命中率 = 100%`
- [ ] 连续观测窗口内 `world/forum一致率 >= 98%`
- [ ] 连续观测窗口内无新增 P0/P1
- [ ] 回滚预案已演练

## 回滚记录

| 回滚ID | 时间 | 触发条件 | 回滚动作 | 影响时长 | 恢复情况 | 复盘结论 |
|---|---|---|---|---|---|---|
| RB-001 |  |  |  |  |  |  |

## 收口与归档

- [ ] 清理临时兼容逻辑。
- [ ] 更新维护文档与故障定位手册。
- [ ] 补齐最终回归报告与证据链接。
- [ ] 形成“已关闭风险清单”。

## 关联文档

- 计划：`plan/state-variable-repair-phase-checklist.md`
- 清单：`plan/state-variable-inventory.md`
- 回归：`plan/state-variable-regression-report.md`

## 变更记录

| 日期 | 修改人 | 变更内容 |
|---|---|---|
|  |  | 初始化模板 |
