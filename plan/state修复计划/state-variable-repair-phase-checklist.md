# State变量全面修复计划（Phase Checklist）

## 1. 目标与范围

- 目标：仅修复 **state变量链路**，解决“变量不填、显示缺失、来源混写”的问题。
- 范围：`story/state/memory/map` 四服务分工、state写入入口、变量完整性、世界/论坛轮次更新一致性、可观测性与回归门禁。
- 非目标：不做剧情内容改写、不做UI重设计、不做与变量无关的性能重构。

## 2. 硬约束（全流程必须满足）

- [ ] `memory` 为独立API，不走 `state` 回退，不借用其他服务。
- [ ] “世界/论坛”仅按UI手动设置的“世界更新间隔回合”推进。
- [ ] apikey固定四分工：`story / state / memory / map`，各司其职，不回退。
- [ ] 正文不承担state变量写入，state变量仅由state链路负责。

## 3. 关键定义

- 旧路径（legacy path）：`set/add/push/delete + gameState.*` 形式的路径写入。
- 当前策略目标：旧路径仅保留兼容/拦截能力，不承担业务变量写入。
- 变量块：影响前端显示和状态推进的业务字段（世界、论坛、社交、手机、任务、背包、经济等）。

## 4. Phase Checklist

## Phase 0：基线冻结与变量盘点

### 目标
建立统一修复基线，明确“哪些变量必须填、哪些允许空、哪些只是UI瞬态字段”。

### Checklist
- [ ] 冻结当前修复范围与规则（仅变量块）。
- [ ] 产出变量域清单：`SYS/世界/论坛/手机/社交/任务/背包/经济`。
- [ ] 标记字段级别：`必填`、`可空`、`UI瞬态`。
- [ ] 建立“缺失矩阵”：`变量名 -> 来源服务 -> 当前缺失表现 -> 影响UI`。
- [ ] 建立“问题追踪ID”规范（便于后续测试与回归闭环）。

### 完成标准
- [ ] 有一份可执行的字段清单与缺失矩阵。
- [ ] 每个问题都可映射到具体变量与具体显示模块。

### 风险与回滚
- 风险：变量定义不全导致后续修复漏项。
- 回滚：若盘点发现范围漂移，回退到Phase 0重新冻结清单后再进入Phase 1。

---

## Phase 1：四服务配置硬隔离（先配置，后业务）

### 目标
从配置层面彻底阻断跨服务回退，尤其是 `memory -> state`。

### Checklist
- [ ] 移除 `memory` 对 `state/story/map` 的回退链。
- [ ] `story/state/memory/map` 分别独立校验 `apiKey/baseUrl/modelId`。
- [ ] 任一服务未配置时：只影响该服务自身，不静默借用其他服务。
- [ ] 保留迁移兼容能力，但禁用“迁移后自动回退借用”行为。
- [ ] 输出配置体检结果（四服务状态一览）。

### 完成标准
- [ ] 任何单服务缺配置都不会污染其他服务职责。
- [ ] `memory` 缺配置时不会触发 `state` 或 `story` 代跑。

### 风险与回滚
- 风险：历史配置用户首次进入出现“某服务未配置”提示增多。
- 回滚：仅回滚提示策略，不回滚职责隔离原则。

---

## Phase 2：state写入口统一（禁正文代写变量）

### 目标
确保业务state写入只走state链路；正文/旧路径不再直接写业务变量。

### Checklist
- [ ] 统一state变量写入入口到state writer/表命令链路。
- [ ] 旧路径 `set/add/push/delete + gameState.*` 对业务域字段一律拦截。
- [ ] 仅保留UI瞬态字段可写（如处理中、界面态）。
- [ ] 对被拦截命令提供可见错误（系统日志），不只打console。
- [ ] 对“正文输出中的state写意图”进行拒绝并给出明确原因。

### 完成标准
- [ ] 正文链路无法直接改写业务state变量。
- [ ] 所有业务变量写入均可追溯到state链路。

### 风险与回滚
- 风险：旧格式指令历史较多，短期内拦截量上升。
- 回滚：可短期开启“告警不拦截”观察，但必须保留可观测性并设截止时间。

---

## Phase 3：变量完整性修复（核心）

### 目标
修复“state变量很多内容不填”的根因，确保关键字段可用。

### Checklist
- [ ] 为每个变量域建立“最小必填集（MRS）”。
- [ ] 建立字段默认值策略（空值语义清晰，不伪造业务事实）。
- [ ] state写入后执行字段完整性检查：缺关键字段直接标记失败。
- [ ] 对失败结果记录缺失字段清单与上下文（回合、服务、命令来源）。
- [ ] 对前端关键显示字段做兜底读取（仅展示兜底，不写回污染数据）。

### 完成标准
- [ ] 关键面板字段“长期空白”问题显著下降并可量化。
- [ ] 每次缺失都能定位到具体字段与失败环节。

### 风险与回滚
- 风险：默认值策略过强，掩盖真实数据问题。
- 回滚：默认值仅用于展示层，不进入持久化层。

---

## Phase 4：世界/论坛轮次一致性修复

### 目标
“世界/论坛”更新严格服从UI配置轮次，不出现漂移、重复或永不触发。

### Checklist
- [ ] cadence单一真源：`世界更新间隔回合`。
- [ ] `interval=0` 明确为手动模式：不自动推进，状态可见。
- [ ] 校验 `下次更新回合` 计算与写回时机（初始化、切换频率、到点触发后重排）。
- [ ] 校验世界与论坛同步策略（论坛是否复用世界间隔）。
- [ ] 在调试信息中显示 `currentTurn / nextTurn / interval / due`。

### 完成标准
- [ ] UI设置改动后，轮次行为与预期一致。
- [ ] 不再出现“设置了轮次但不更新”或“未到轮次提前更新”。

### 风险与回滚
- 风险：历史旧字段（如更新频率）与新字段并存导致歧义。
- 回滚：仅保留读取兼容，写入统一到新字段。

---

## Phase 5：可观测性与故障可见化

### 目标
把“为什么变量没填”从猜测变成可追踪证据。

### Checklist
- [ ] 每次变量写入记录：服务来源、目标变量域、命令类型、结果。
- [ ] 标准化拒绝原因：`legacy_path_blocked`、`cadence_not_due`、`missing_required_field` 等。
- [ ] 系统日志显示用户可理解的错误摘要。
- [ ] 调试面板增加“最近N条变量写失败”视图。
- [ ] 建立“高频失败Top榜”用于后续专项修复。

### 完成标准
- [ ] 任一变量缺失都可追溯到“谁写的、为何失败、失败在哪”。
- [ ] 不再出现“静默失败无人可见”的问题。

### 风险与回滚
- 风险：日志过多影响排查效率。
- 回滚：分级日志（默认摘要，详细日志按需打开）。

---

## Phase 6：测试与回归门禁（仅变量块）

### 目标
将修复固化为自动化门禁，防止回归。

### Checklist
- [ ] 单测：`memory` 缺配置时不得回退到 `state`。
- [ ] 单测：旧路径业务写入应被拦截并产生日志。
- [ ] 单测：世界/论坛轮次与UI设置一致。
- [ ] 单测：关键变量域“最小必填集”校验。
- [ ] 集成回归：一次完整回合链路，验证前端关键显示字段。

### 完成标准
- [ ] 变量相关测试全绿。
- [ ] 回归报告包含“修复前后缺失率对比”。

### 风险与回滚
- 风险：测试覆盖不全导致误判“已修复”。
- 回滚：提高关键路径覆盖率后再放行。

---

## Phase 7：灰度切换与收口

### 目标
平滑上线，确保“严格模式”稳定后再清理兼容代码。

### Checklist
- [ ] 先 shadow 模式观测（记录不拦截）一轮真实数据。
- [ ] 再切严格模式（拦截旧路径业务写入）。
- [ ] 监控失败率、缺失率、用户可见错误率。
- [ ] 稳定后清理临时兼容与重复分支。
- [ ] 更新维护文档（变量分工、故障定位手册）。

### 完成标准
- [ ] 严格模式稳定运行，无新增高优先级变量缺失问题。
- [ ] 兼容债务有明确关闭记录。

### 风险与回滚
- 风险：切严格后短期告警暴增。
- 回滚：短期退回shadow并按失败Top榜逐项消化，再二次切换。

## 5. 验收口径（必须全部满足）

- [ ] 分工正确：`story/state/memory/map` 不串岗。
- [ ] memory独立：不经state回退。
- [ ] 正文不写state：旧路径业务写被拦截。
- [ ] 世界/论坛按轮次：与UI设置一致。
- [ ] 变量完整性达标：关键显示字段可稳定获取。
- [ ] 故障可见：任何失败都可定位与复现。

## 6. 交付物清单

- [ ] 本计划文档（当前文件）。
- [ ] 变量域清单与最小必填集（建议另存：`plan/state-variable-inventory.md`）。
- [ ] 回归测试清单与结果（建议另存：`plan/state-variable-regression-report.md`）。
- [ ] 灰度观测记录（建议另存：`plan/state-variable-rollout-log.md`）。
